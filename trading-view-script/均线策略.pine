//@version=6
strategy('åŒå‡çº¿äº¤æ˜“ç­–ç•¥', overlay = true, margin_long = 100, margin_short = 100, initial_capital = 3000, process_orders_on_close = true)

// === åŸºç¡€å‚æ•°è¾“å…¥ ===
lenSMA1 = input.int(20, title = 'SMA1')
lenEMA1 = input.int(20, title = 'EMA1')
lenSMA2 = input.int(60, title = 'SMA2')
lenEMA2 = input.int(60, title = 'EMA2')
lenSMA3 = input.int(120, title = 'SMA3')
lenEMA3 = input.int(120, title = 'EMA3')

// === æ˜¾ç¤ºæ§åˆ¶ ===
showInfoTable = input.bool(false, title = 'æ˜¾ç¤ºä¿¡æ¯è¡¨æ ¼')
enableMA = input.bool(true, title = 'å¯ç”¨å‡çº¿')

// === Kçº¿æ ‡è®°è®¾ç½® ===
enableCandleMarking = input.bool(true, title = 'å¯ç”¨Kçº¿æ ‡è®°')
enableVolumeBackground = input.bool(false, title = 'å¯ç”¨é‡ä»·å…³ç³»')
riseThreshold = 2.0  // å›ºå®šé˜ˆå€¼2%
fallThreshold = 2.0  // å›ºå®šé˜ˆå€¼2%




// === å‡çº¿è®¡ç®— ===
sma1 = ta.sma(close, lenSMA1)
ema1 = ta.ema(close, lenEMA1)
sma2 = ta.sma(close, lenSMA2)
ema2 = ta.ema(close, lenEMA2)
sma3 = ta.sma(close, lenSMA3)
ema3 = ta.ema(close, lenEMA3)

// === é¢œè‰²å®šä¹‰ ===
sma1Color = color.rgb(255, 230, 100) // æµ…é»„
ema1Color = color.rgb(200, 160, 0) // æ·±é»„
sma2Color = color.rgb(120, 200, 255) // æµ…è“
ema2Color = color.rgb(0, 80, 200) // æ·±è“
sma3Color = color.rgb(255, 150, 150) // æµ…çº¢
ema3Color = color.rgb(223, 20, 241) // æ·±çº¢

// === ç»˜åˆ¶å‡çº¿ ===
plot(enableMA ? sma1 : na, color = sma1Color, title = 'SMA1', display = display.none)
plot(enableMA ? ema1 : na, color = ema1Color, title = 'EMA1')
plot(enableMA ? sma2 : na, color = sma2Color, title = 'SMA2', display = display.none)
plot(enableMA ? ema2 : na, color = ema2Color, title = 'EMA2')
plot(enableMA ? sma3 : na, color = sma3Color, title = 'SMA3', display = display.none)
plot(enableMA ? ema3 : na, color = ema3Color, title = 'EMA3', display = display.none)

// === Kçº¿å½¢æ€è¯†åˆ« ===
// è®¡ç®—Kçº¿æ¶¨è·Œå¹…
candleChangePercent = (close - open) / open * 100



// === åŸºç¡€æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ï¼ˆç”¨äºé‡ä»·å…³ç³»ï¼‰ ===
avgVolume = ta.sma(volume, 20)

// é‡ä»·åˆ¤æ–­é˜ˆå€¼
volumeHighThreshold = 1.5  // é«˜æˆäº¤é‡é˜ˆå€¼å€æ•°
volumeLowThreshold = 0.7   // ä½æˆäº¤é‡é˜ˆå€¼å€æ•°

// é‡ä»·èƒŒæ™¯åˆ¤æ–­
isHighVolume = volume >= avgVolume * volumeHighThreshold
isLowVolume = volume <= avgVolume * volumeLowThreshold

// åŸæœ‰é€»è¾‘ä¿æŒ
isObviousRise = enableCandleMarking and candleChangePercent >= riseThreshold and close > open
isObviousFall = enableCandleMarking and candleChangePercent <= -fallThreshold and close < open

// è¶‹åŠ¿åˆ¤æ–­ï¼ˆä»ç­–ç•¥éƒ¨åˆ†æå‰åˆ°è¿™é‡Œï¼‰
fastMA = ema1  // ä½¿ç”¨EMA1ä½œä¸ºå¿«çº¿
slowMA = ema2  // ä½¿ç”¨EMA2ä½œä¸ºæ…¢çº¿
trendUp = fastMA > slowMA
trendDown = fastMA < slowMA

// è®¡ç®—Kçº¿å®ä½“å¤§å°ï¼ˆç”¨äºæ ‡è®°å¼ºåº¦åˆ¤æ–­ï¼‰
candleBodySize = math.abs(close - open)
avgBodySize = ta.sma(candleBodySize, 20) // 20å‘¨æœŸå¹³å‡å®ä½“å¤§å°
isStrongCandle = candleBodySize > avgBodySize * 1.5 // å®ä½“å¤§äºå¹³å‡å€¼1.5å€è§†ä¸ºå¼ºåŠ¿Kçº¿

// è®¡ç®—èƒŒæ™¯æ¸å˜é€æ˜åº¦ï¼ˆæ ¹æ®æ¶¨è·Œå¹…å¼ºåº¦ï¼‰
riseIntensity = 0.0
fallIntensity = 0.0

if enableCandleMarking
    if isObviousRise // æ™®é€šä¸Šæ¶¨
        riseIntensity := math.round(math.min(math.abs(candleChangePercent) * 5, 35))
    
    if isObviousFall // æ™®é€šä¸‹è·Œ
        fallIntensity := math.round(math.min(math.abs(candleChangePercent) * 5, 35))

// === Kçº¿å½¢æ€æ ‡è®° ===
// Kçº¿èƒŒæ™¯æ¸å˜ï¼ˆæ ¹æ®æ¶¨è·Œå¹…å¼ºåº¦æ˜¾ç¤ºï¼‰
traditionalBgColor = riseIntensity > 0 ? color.new(color.green, 100 - riseIntensity) : 
                     fallIntensity > 0 ? color.new(color.red, 100 - fallIntensity) : na

// é‡ä»·å…³ç³»èƒŒæ™¯ï¼ˆä»…åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰
var color volumePriceBgColor = na
volumePriceBgColor := na
if enableVolumeBackground and enableCandleMarking
    if isObviousRise and isHighVolume
        volumePriceBgColor := color.new(color.lime, 80)  // æ¶¨é‡
    else if isObviousFall and isHighVolume
        volumePriceBgColor := color.new(color.red, 80)   // è·Œé‡
    else if isObviousRise and isLowVolume
        volumePriceBgColor := color.new(color.orange, 85) // æ¶¨ç¼©é‡
    else if isObviousFall and isLowVolume
        volumePriceBgColor := color.new(color.purple, 85) // è·Œç¼©é‡

// åº”ç”¨èƒŒæ™¯é¢œè‰²
// å½“å¯ç”¨é‡ä»·å…³ç³»æ—¶ï¼Œä¼˜å…ˆæ˜¾ç¤ºé‡ä»·èƒŒæ™¯ï¼Œå¦åˆ™æ˜¾ç¤ºä¼ ç»Ÿæ¶¨è·ŒèƒŒæ™¯
finalBgColor = enableVolumeBackground ? (not na(volumePriceBgColor) ? volumePriceBgColor : traditionalBgColor) : na
bgcolor(finalBgColor, title = 'Kçº¿èƒŒæ™¯')

// === Kçº¿æ‚¬åœä¿¡æ¯åŠŸèƒ½ ===
// æ„å»ºKçº¿è¯¦ç»†åˆ†æä¿¡æ¯ç”¨äºé¼ æ ‡æ‚¬åœæ˜¾ç¤º
var string candleTooltip = ""
if enableCandleMarking
    candleTooltip := "=== Kçº¿åˆ†æ ===\n"
    
    // åŸºç¡€Kçº¿ä¿¡æ¯
    candleTooltip += "å¼€ç›˜ä»·: " + str.tostring(open, "#.####") + "\n"
    candleTooltip += "æœ€é«˜ä»·: " + str.tostring(high, "#.####") + "\n"
    candleTooltip += "æœ€ä½ä»·: " + str.tostring(low, "#.####") + "\n"
    candleTooltip += "æ”¶ç›˜ä»·: " + str.tostring(close, "#.####") + "\n"
    candleTooltip += "æ¶¨è·Œå¹…: " + str.tostring(candleChangePercent, "#.##") + "%\n"
    
    // Kçº¿å½¢æ€åˆ¤æ–­
    if isObviousRise
        candleTooltip += "\nğŸ“ˆ æ˜æ˜¾ä¸Šæ¶¨ä¿¡å·"
        candleTooltip += "\næ¶¨å¹…è¶…è¿‡ " + str.tostring(riseThreshold, "#.#") + "% é˜ˆå€¼"
    else if isObviousFall
        candleTooltip += "\nğŸ“‰ æ˜æ˜¾ä¸‹è·Œä¿¡å·"
        candleTooltip += "\nè·Œå¹…è¶…è¿‡ " + str.tostring(fallThreshold, "#.#") + "% é˜ˆå€¼"
    else
        candleTooltip += "\nâ¡ï¸ æ­£å¸¸æ³¢åŠ¨"
        candleTooltip += "\næ³¢åŠ¨å¹…åº¦åœ¨æ­£å¸¸èŒƒå›´å†…"
    
    // æˆäº¤é‡åˆ†æ
    candleTooltip += "\n\n=== æˆäº¤é‡åˆ†æ ==="
    candleTooltip += "\nå½“å‰æˆäº¤é‡: " + str.tostring(volume, "#") + "\n"
    candleTooltip += "å¹³å‡æˆäº¤é‡: " + str.tostring(avgVolume, "#") + "\n"
    candleTooltip += "é‡èƒ½å€æ•°: " + str.tostring(volume/avgVolume, "#.##") + "å€\n"
    
    if isHighVolume
        candleTooltip += "ğŸ“Š é«˜æˆäº¤é‡ (>" + str.tostring(volumeHighThreshold, "#.#") + "å€å¹³å‡é‡)"
    else if isLowVolume
        candleTooltip += "ğŸ“Š ä½æˆäº¤é‡ (<" + str.tostring(volumeLowThreshold, "#.#") + "å€å¹³å‡é‡)"
    else
        candleTooltip += "ğŸ“Š æ­£å¸¸æˆäº¤é‡"
    
    // é‡ä»·å…³ç³»åˆ†æ
    candleTooltip += "\n\n=== é‡ä»·å…³ç³» ==="
    if isObviousRise and isHighVolume
        candleTooltip += "\nğŸŸ¢ æ¶¨é‡é…åˆ - å¥åº·ä¸Šæ¶¨"
        candleTooltip += "\nä»·æ ¼ä¸Šæ¶¨ä¼´éšæˆäº¤é‡æ”¾å¤§ï¼Œå¤šå¤´åŠ›é‡å¼ºåŠ²"
    else if isObviousRise and isLowVolume
        candleTooltip += "\nğŸŸ¡ æ¶¨ç¼©é‡ - éœ€è¦è­¦æƒ•"
        candleTooltip += "\nä»·æ ¼ä¸Šæ¶¨ä½†æˆäº¤é‡èç¼©ï¼Œä¸Šæ¶¨åŠ¨èƒ½ä¸è¶³"
    else if isObviousFall and isHighVolume
        candleTooltip += "\nğŸ”´ è·Œé‡é‡Šæ”¾ - ç©ºå¤´å‘åŠ›"
        candleTooltip += "\nä»·æ ¼ä¸‹è·Œä¼´éšæˆäº¤é‡æ”¾å¤§ï¼ŒæŠ›å‹æ²‰é‡"
    else if isObviousFall and isLowVolume
        candleTooltip += "\nğŸŸ  è·Œç¼©é‡ - æ€è·Œæœ‰é™"
        candleTooltip += "\nä»·æ ¼ä¸‹è·Œä½†æˆäº¤é‡èç¼©ï¼Œä¸‹è·ŒåŠ¨èƒ½å‡å¼±"
    else
        candleTooltip += "\nâšª æ­£å¸¸éœ‡è¡"
        candleTooltip += "\né‡ä»·å…³ç³»å¹³ç¨³ï¼Œæ— æ˜æ˜¾å¼‚å¸¸"
    
    // å‡çº¿å…³ç³»
    candleTooltip += "\n\n=== å‡çº¿å…³ç³» ==="
    candleTooltip += "\nEMA1(20): " + str.tostring(ema1, "#.####")
    candleTooltip += "\nEMA2(60): " + str.tostring(ema2, "#.####")
    candleTooltip += "\nä»·æ ¼ä¸EMA1: " + (close > ema1 ? "ä¸Šæ–¹ +" : "ä¸‹æ–¹ ") + str.tostring(((close - ema1) / ema1) * 100, "#.##") + "%"
    candleTooltip += "\nä»·æ ¼ä¸EMA2: " + (close > ema2 ? "ä¸Šæ–¹ +" : "ä¸‹æ–¹ ") + str.tostring(((close - ema2) / ema2) * 100, "#.##") + "%"
    
    // è¶‹åŠ¿åˆ¤æ–­
    if trendUp
        candleTooltip += "\nğŸ“ˆ å¤šå¤´è¶‹åŠ¿ (å¿«çº¿>æ…¢çº¿)"
    else
        candleTooltip += "\nğŸ“‰ ç©ºå¤´è¶‹åŠ¿ (å¿«çº¿<æ…¢çº¿)"

// === Kçº¿æ ‡è®°æ˜¾ç¤º ===
// åœ¨Kçº¿ä¸‹æ–¹æ˜¾ç¤ºæ ‡è®°ï¼Œé¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†æç¤ºæ¡†
if enableCandleMarking
    // æ„å»ºæç¤ºä¿¡æ¯
    tooltipText = "=== Kçº¿åˆ†æ ===\n"
    tooltipText += "OHLC: " + str.tostring(open, "#.##") + " | " + str.tostring(high, "#.##") + " | " + str.tostring(low, "#.##") + " | " + str.tostring(close, "#.##") + "\n"
    tooltipText += "æ¶¨è·Œå¹…: " + str.tostring(candleChangePercent, "#.##") + "%\n\n"
    
    // æˆäº¤é‡åˆ†æ
    tooltipText += "=== æˆäº¤é‡åˆ†æ ===\n"
    tooltipText += "å½“å‰é‡: " + str.tostring(volume, "#") + "\n"
    tooltipText += "å¹³å‡é‡: " + str.tostring(avgVolume, "#") + "\n"
    tooltipText += "é‡èƒ½å€æ•°: " + str.tostring(volume/avgVolume, "#.##") + "å€\n"
    
    if isHighVolume
        tooltipText += "ğŸ“Š é«˜æˆäº¤é‡ (>" + str.tostring(volumeHighThreshold, "#.#") + "å€)\n\n"
    else if isLowVolume
        tooltipText += "ğŸ“Š ä½æˆäº¤é‡ (<" + str.tostring(volumeLowThreshold, "#.#") + "å€)\n\n"
    else
        tooltipText += "ğŸ“Š æ­£å¸¸æˆäº¤é‡\n\n"
    
    // é‡ä»·å…³ç³»
    tooltipText += "=== é‡ä»·å…³ç³» ===\n"
    if isObviousRise and isHighVolume
        tooltipText += "ğŸŸ¢ æ¶¨é‡é…åˆ - å¥åº·ä¸Šæ¶¨\n"
    else if isObviousRise and isLowVolume
        tooltipText += "ğŸŸ¡ æ¶¨ç¼©é‡ - éœ€è¦è­¦æƒ•\n"
    else if isObviousFall and isHighVolume
        tooltipText += "ğŸ”´ è·Œé‡é‡Šæ”¾ - ç©ºå¤´å‘åŠ›\n"
    else if isObviousFall and isLowVolume
        tooltipText += "ğŸŸ  è·Œç¼©é‡ - æ€è·Œæœ‰é™\n"
    else
        tooltipText += "âšª æ­£å¸¸éœ‡è¡\n"
    
    // å‡çº¿å…³ç³»
    tooltipText += "\n=== å‡çº¿å…³ç³» ===\n"
    tooltipText += "EMA1(20): " + str.tostring(ema1, "#.####") + "\n"
    tooltipText += "EMA2(60): " + str.tostring(ema2, "#.####") + "\n"
    tooltipText += "ä¸EMA1è·ç¦»: " + str.tostring(((close - ema1) / ema1) * 100, "#.##") + "%\n"
    tooltipText += "ä¸EMA2è·ç¦»: " + str.tostring(((close - ema2) / ema2) * 100, "#.##") + "%\n"
    
    // è¶‹åŠ¿åˆ¤æ–­
    tooltipText += "\n=== è¶‹åŠ¿çŠ¶æ€ ===\n"
    tooltipText += trendUp ? "ğŸ“ˆ å¤šå¤´è¶‹åŠ¿ (EMA1>EMA2)" : "ğŸ“‰ ç©ºå¤´è¶‹åŠ¿ (EMA1<EMA2)"
    
    // æ ¹æ®Kçº¿ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡è®°
    if isObviousRise
        label.new(bar_index, low, text="ğŸ“ˆ", style=label.style_label_up, 
                  color=color.new(color.green, 0), textcolor=color.white, 
                  size=size.small, tooltip=tooltipText)
    else if isObviousFall
        label.new(bar_index, low, text="ğŸ“‰", style=label.style_label_up, 
                  color=color.new(color.red, 0), textcolor=color.white, 
                  size=size.small, tooltip=tooltipText)
    else if math.abs(candleChangePercent) > 1.0  // å¯¹äºæ³¢åŠ¨è¶…è¿‡1%çš„Kçº¿ä¹Ÿæ˜¾ç¤ºæ ‡è®°
        label.new(bar_index, low, text="ğŸ“Š", style=label.style_label_up, 
                  color=color.new(color.blue, 0), textcolor=color.white, 
                  size=size.tiny, tooltip=tooltipText)


// ===================================================
// === ä¸“ä¸šäº¤æ˜“ç­–ç•¥å‚æ•° ===
// ===================================================

// === äº¤æ˜“ç­–ç•¥æ€»å¼€å…³ ===
enableStrategy = input.bool(true, title = 'å¯ç”¨äº¤æ˜“ç­–ç•¥')

// === äº¤æ˜“æ–¹å‘è®¾ç½® ===
tradeDirection = input.string('çœ‹å¤š', title = 'äº¤æ˜“æ–¹å‘', options = ['çœ‹å¤š', 'çœ‹ç©º', 'æ‰€æœ‰'])

// ç­–ç•¥å¿«çº¿é€‰æ‹©
strategyFast = input.string('EMA1', title = 'ç­–ç•¥å¿«çº¿', options = ['EMA1', 'SMA1', 'EMA2', 'SMA2', 'EMA3', 'SMA3'])
// ç­–ç•¥æ…¢çº¿é€‰æ‹©
strategySlow = input.string('EMA2', title = 'ç­–ç•¥æ…¢çº¿', options = ['EMA1', 'SMA1', 'EMA2', 'SMA2', 'EMA3', 'SMA3'])

// === äº¤æ˜“æ—¥æœŸæ§åˆ¶ ===
startDate = input.time(timestamp("2025-01-01 00:00"), title = 'äº¤æ˜“å¼€å§‹æ—¥æœŸ')
endDate = input.time(timestamp("2099-01-01 00:00"), title = 'äº¤æ˜“ç»“æŸæ—¥æœŸ')

// === äº¤æ˜“æ—¥æœŸæ£€æŸ¥ ===
isInTradingPeriod = time >= startDate and time <= endDate


// === äº¤æ˜“æ‰§è¡Œä»·æ ¼ ===
entryTiming = input.string('æ”¶ç›˜ä»·', title = 'å¼€ä»“æ‰§è¡Œä»·æ ¼', options = ['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'ç›˜ä¸­'])
exitTiming = input.string('æ”¶ç›˜ä»·', title = 'å¹³ä»“æ‰§è¡Œä»·æ ¼', options = ['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'ç›˜ä¸­'])

// === ç¼“å†²åŒºè®¾ç½® ===
bufferValue = input.float(0.0, title = 'ç¼“å†²åŒºæ•°å€¼', minval = 0.0, maxval = 50.0, step = 0.1, tooltip = 'å¼€ä»“ååœ¨æ­¤åŒºé—´å†…ä¸æ‰§è¡Œå½¢æ€ä¿®å¤å’Œå¹³ä»“ä¿¡å·')
bufferUnit = input.string('%', title = 'ç¼“å†²åŒºå•ä½', options = ['%', 'ä»·æ ¼'])

// === æ ¹æ®é€‰æ‹©è·å–å¯¹åº”çš„å‡çº¿å€¼ï¼ˆç”¨äºç­–ç•¥äº¤æ˜“ï¼‰ ===
strategyFastMA = strategyFast == 'EMA1' ? ema1 : strategyFast == 'SMA1' ? sma1 : strategyFast == 'EMA2' ? ema2 : strategyFast == 'SMA2' ? sma2 : strategyFast == 'EMA3' ? ema3 : sma3
strategySlowMA = strategySlow == 'EMA1' ? ema1 : strategySlow == 'SMA1' ? sma1 : strategySlow == 'EMA2' ? ema2 : strategySlow == 'SMA2' ? sma2 : strategySlow == 'EMA3' ? ema3 : sma3

// === æ ¸å¿ƒä¿¡å·è¯†åˆ« ===
// é‡‘å‰æ­»å‰ä¿¡å·
goldenCross = strategyFastMA > strategySlowMA and strategyFastMA[1] <= strategySlowMA[1] // é‡‘å‰ï¼šå¿«çº¿ä¸Šç©¿æ…¢çº¿
deathCross = strategyFastMA < strategySlowMA and strategyFastMA[1] >= strategySlowMA[1] // æ­»å‰ï¼šå¿«çº¿ä¸‹ç©¿æ…¢çº¿

// ç­–ç•¥è¶‹åŠ¿åˆ¤æ–­
strategyTrendUp = strategyFastMA > strategySlowMA
strategyTrendDown = strategyFastMA < strategySlowMA

// === äº¤æ˜“æ‰§è¡Œä»·æ ¼è®¡ç®— ===
entryPrice_exec = entryTiming == 'å¼€ç›˜ä»·' ? open : entryTiming == 'æ”¶ç›˜ä»·' ? close : close

// === ç¼“å†²åŒºè®¡ç®— ===
var float bufferEntryPrice = na

// è®°å½•çœŸå®å¼€ä»“ä»·æ ¼ï¼ˆä½¿ç”¨ç­–ç•¥çš„å¹³å‡å¼€ä»“ä»·æ ¼ï¼‰
if strategy.position_size[1] == 0 and strategy.position_size != 0
    bufferEntryPrice := strategy.position_avg_price

// é‡ç½®ç¼“å†²åŒºï¼ˆå¹³ä»“æ—¶ï¼‰
if strategy.position_size == 0
    bufferEntryPrice := na

// è®¡ç®—ç¼“å†²åŒºè®¾ç½®
var float bufferUpperBound = na
var float bufferLowerBound = na
var bool bufferEnabled = false

if bufferValue > 0 and not na(bufferEntryPrice)
    if bufferUnit == '%'
        // ç™¾åˆ†æ¯”æ¨¡å¼
        bufferPercent = bufferValue / 100
        bufferUpperBound := bufferEntryPrice * (1 + bufferPercent)
        bufferLowerBound := bufferEntryPrice * (1 - bufferPercent)
    else
        // ä»·æ ¼æ¨¡å¼
        bufferUpperBound := bufferEntryPrice + bufferValue
        bufferLowerBound := bufferEntryPrice - bufferValue
    bufferEnabled := true
else
    bufferUpperBound := na
    bufferLowerBound := na
    bufferEnabled := false

// åˆ¤æ–­æ˜¯å¦åœ¨ç¼“å†²åŒºå†…
inBufferZone = bufferEnabled and not na(bufferEntryPrice) and close >= bufferLowerBound and close <= bufferUpperBound


// === ä¸“ä¸šäº¤æ˜“é€»è¾‘ ===
// === åšå¤šä¿¡å· ===
// 1. åšå¤šå¼€ä»“ä¿¡å·ï¼ˆç¬¬ä¸€æ¬¡é‡‘å‰ï¼‰
longEntrySignal = goldenCross and strategy.position_size == 0 and isInTradingPeriod

// 2. åšå¤šåŠ ä»“ä¿¡å·ï¼ˆé˜³çº¿ + è¶‹åŠ¿å‘ä¸Šï¼‰
// é˜³çº¿åˆ¤æ–­ï¼šæ”¶ç›˜ä»·é«˜äºå¼€ç›˜ä»·
isBullish = close > open

var lastAddPositionBar = 0
// å½“å‰ä»·æ ¼ç›¸å¯¹äºå¿«çº¿çš„åç¦»é‡ï¼Œç”¨äºåˆ¤æ–­å›è¸©
pullbackThreshold = 0.01 // å¯è°ƒå›è¸©å¹…åº¦ï¼Œä¾‹å¦‚ 1%
// åˆ¤æ–­å›è¸©æœªç ´å¿«çº¿
isPullback = close <= strategyFastMA * (1 + pullbackThreshold) and close >= strategyFastMA
// åŠ ä»“æ¡ä»¶ï¼šé˜³çº¿ + è¶‹åŠ¿å‘ä¸Š + å·²æœ‰å¤šå¤´ä»“ä½ + æ˜ç¡®å›è¸©å¿«çº¿
longAddSignal = isBullish and strategyTrendUp and strategy.position_size > 0 and isPullback and isInTradingPeriod

// 3. åšå¤šå¹³ä»“ä¿¡å·ï¼ˆæ­»å‰æˆ–å½¢æ€ç ´å¿«çº¿ï¼‰
// å½¢æ€ç ´å¿«çº¿åˆ¤æ–­ï¼šä»·æ ¼è·Œç ´å¿«çº¿
breakFastLine = close < strategyFastMA
// åŸºç¡€å¹³ä»“ä¿¡å·ï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
longExitSignal = (deathCross or breakFastLine) and strategy.position_size > 0 and not inBufferZone

// 4. åšå¤šé‡æ–°å…¥åœºä¿¡å·ï¼ˆå½¢æ€ä¿®å¤ï¼‰
// å½“ä»·æ ¼é‡æ–°å›åˆ°å¿«çº¿ä¹‹ä¸Šæ—¶ï¼Œå¯ä»¥é‡æ–°å…¥åœºï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
longReEntrySignal = close > strategyFastMA and strategy.position_size == 0 and strategyTrendUp and isInTradingPeriod and not inBufferZone

// === åšç©ºä¿¡å· ===
// 1. åšç©ºå¼€ä»“ä¿¡å·ï¼ˆç¬¬ä¸€æ¬¡æ­»å‰ï¼‰
shortEntrySignal = deathCross and strategy.position_size == 0 and isInTradingPeriod

// 2. åšç©ºåŠ ä»“ä¿¡å·ï¼ˆé˜´çº¿ + è¶‹åŠ¿å‘ä¸‹ï¼‰
// é˜´çº¿åˆ¤æ–­ï¼šæ”¶ç›˜ä»·ä½äºå¼€ç›˜ä»·
isBearish = close < open
// åˆ¤æ–­åå¼¹æœªç ´å¿«çº¿
isRebound = close >= strategyFastMA * (1 - pullbackThreshold) and close <= strategyFastMA
// åŠ ä»“æ¡ä»¶ï¼šé˜´çº¿ + è¶‹åŠ¿å‘ä¸‹ + å·²æœ‰ç©ºå¤´ä»“ä½ + æ˜ç¡®åå¼¹è‡³å¿«çº¿
shortAddSignal = isBearish and strategyTrendDown and strategy.position_size < 0 and isRebound and isInTradingPeriod

// 3. åšç©ºå¹³ä»“ä¿¡å·ï¼ˆé‡‘å‰æˆ–å½¢æ€ç ´å¿«çº¿ï¼‰
// å½¢æ€ç ´å¿«çº¿åˆ¤æ–­ï¼ˆåšç©ºæ—¶ä¸ºä»·æ ¼æ¶¨ç ´å¿«çº¿ï¼‰
breakFastLineShort = close > strategyFastMA
// åŸºç¡€å¹³ä»“ä¿¡å·ï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
shortExitSignal = (goldenCross or breakFastLineShort) and strategy.position_size < 0 and not inBufferZone

// 4. åšç©ºé‡æ–°å…¥åœºä¿¡å·ï¼ˆå½¢æ€ä¿®å¤ï¼‰
// å½“ä»·æ ¼é‡æ–°è·Œç ´å¿«çº¿æ—¶ï¼Œå¯ä»¥é‡æ–°åšç©ºå…¥åœºï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
shortReEntrySignal = close < strategyFastMA and strategy.position_size == 0 and strategyTrendDown and isInTradingPeriod and not inBufferZone

// === å…¼å®¹æ€§å˜é‡ï¼ˆä¿æŒåŸæœ‰å˜é‡åï¼‰ ===
firstEntrySignal = longEntrySignal
pullbackSignal = longAddSignal
exitSignal = longExitSignal
reEntrySignal = longReEntrySignal

// === äº¤æ˜“æ‰§è¡Œä»·æ ¼åˆ¤æ–­ ===
canEntry = entryTiming == 'ç›˜ä¸­' or (entryTiming == 'å¼€ç›˜ä»·' and barstate.isconfirmed) or (entryTiming == 'æ”¶ç›˜ä»·' and barstate.isconfirmed)
canExit = exitTiming == 'ç›˜ä¸­' or (exitTiming == 'å¼€ç›˜ä»·' and barstate.isconfirmed) or (exitTiming == 'æ”¶ç›˜ä»·' and barstate.isconfirmed)

// æ ¹æ®é€‰æ‹©ç¡®å®šå¹³ä»“æ‰§è¡Œä»·æ ¼
exitPrice_exec = exitTiming == 'å¼€ç›˜ä»·' ? open : exitTiming == 'æ”¶ç›˜ä»·' ? close : close

// === äº¤æ˜“æ‰§è¡Œ ===
if enableStrategy
    // === åšå¤šäº¤æ˜“æ‰§è¡Œ ===
    if tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'
        // åšå¤šå¼€ä»“
        if longEntrySignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é‡‘å‰å¼€ä»“', strategy.long, qty = strategy.equity / entryPrice_exec)

        // åšå¤šåŠ ä»“
        if longAddSignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é˜³çº¿åŠ ä»“', strategy.long, qty = strategy.equity * 0.2 / entryPrice_exec)

        // åšå¤šå¹³ä»“
        if longExitSignal and canExit
            exitComment = deathCross ? 'æ­»å‰å¹³ä»“' : 'ç ´çº¿å¹³ä»“'
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.close_all(comment = exitComment)

        // åšå¤šé‡æ–°å…¥åœº
        if longReEntrySignal and canEntry
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.entry('å½¢æ€ä¿®å¤å…¥åœº', strategy.long, qty = strategy.equity / entryPrice_exec)

    // === åšç©ºäº¤æ˜“æ‰§è¡Œ ===
    if tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'
        // åšç©ºå¼€ä»“
        if shortEntrySignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('æ­»å‰å¼€ç©º', strategy.short, qty = strategy.equity / entryPrice_exec)

        // åšç©ºåŠ ä»“
        if shortAddSignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é˜´çº¿åŠ ç©º', strategy.short, qty = strategy.equity * 0.2 / entryPrice_exec)

        // åšç©ºå¹³ä»“
        if shortExitSignal and canExit
            exitComment = goldenCross ? 'é‡‘å‰å¹³ä»“' : 'ç ´çº¿å¹³ä»“'
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.close_all(comment = exitComment)

        // åšç©ºé‡æ–°å…¥åœº
        if shortReEntrySignal and canEntry
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.entry('å½¢æ€ä¿®å¤åšç©º', strategy.short, qty = strategy.equity / entryPrice_exec)

// === ä¿¡å·æ ‡è®° ===
// åšå¤šä¿¡å·æ ‡è®°
plotshape(enableStrategy and longEntrySignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šå¼€ä»“', location = location.belowbar, color = color.green, style = shape.triangleup, size = size.normal)
plotshape(enableStrategy and longAddSignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šåŠ ä»“', location = location.belowbar, color = color.blue, style = shape.circle, size = size.small)
plotshape(enableStrategy and longExitSignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šå¹³ä»“', location = location.abovebar, color = color.red, style = shape.triangledown, size = size.normal)
plotshape(enableStrategy and longReEntrySignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šé‡å…¥', location = location.belowbar, color = color.lime, style = shape.diamond, size = size.small)

// åšç©ºä¿¡å·æ ‡è®°
plotshape(enableStrategy and shortEntrySignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºå¼€ä»“', location = location.abovebar, color = color.orange, style = shape.triangledown, size = size.normal)
plotshape(enableStrategy and shortAddSignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºåŠ ä»“', location = location.abovebar, color = color.purple, style = shape.circle, size = size.small)
plotshape(enableStrategy and shortExitSignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºå¹³ä»“', location = location.belowbar, color = color.yellow, style = shape.triangleup, size = size.normal)
plotshape(enableStrategy and shortReEntrySignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºé‡å…¥', location = location.abovebar, color = color.fuchsia, style = shape.diamond, size = size.small)

// === ç¼“å†²åŒºå¯è§†åŒ– ===
// ç¼“å†²åŒºå®ä½“æ˜¾ç¤ºï¼Œåªåœ¨ä»·æ ¼æœªçªç ´æ—¶æ˜¾ç¤º
bufferShow = bufferEnabled and not na(bufferUpperBound) and not na(bufferLowerBound) and not na(bufferEntryPrice) and close <= bufferUpperBound and close >= bufferLowerBound

// ç»˜åˆ¶ç¼“å†²åŒºä¸Šè¾¹ç•Œçº¿
bufferUpperLine = bufferShow ? bufferUpperBound : na
plot(bufferUpperLine, color = color.new(color.orange, 50), linewidth = 2, title = 'ç¼“å†²åŒºä¸Šè¾¹ç•Œ', style = plot.style_line)

// ç»˜åˆ¶ç¼“å†²åŒºä¸‹è¾¹ç•Œçº¿  
bufferLowerLine = bufferShow ? bufferLowerBound : na
plot(bufferLowerLine, color = color.new(color.orange, 50), linewidth = 2, title = 'ç¼“å†²åŒºä¸‹è¾¹ç•Œ', style = plot.style_line)

// ç»˜åˆ¶ç¼“å†²åŒºä¸­çº¿ï¼ˆå¼€ä»“åŸºå‡†ä»·ï¼‰
bufferCenterLine = bufferShow ? bufferEntryPrice : na
plot(bufferCenterLine, color = color.new(color.blue, 60), linewidth = 1, title = 'å¼€ä»“åŸºå‡†ä»·', style = plot.style_line, linestyle = plot.linestyle_dashed)

// ç¼“å†²åŒºé€æ˜å®ä½“èƒŒæ™¯
fill(plot(bufferUpperLine, display = display.none), plot(bufferLowerLine, display = display.none), color = color.new(color.orange, 85), title = 'ç¼“å†²åŒºå®ä½“')

// === ç­–ç•¥ä¿¡æ¯æ˜¾ç¤º ===
var table infoTable = showInfoTable ? table.new(position.top_right, 2, enableCandleMarking ? 17 : 12, bgcolor = color.white, border_width = 1) : na
if barstate.islast and showInfoTable and not na(infoTable)
    table.cell(infoTable, 0, 0, 'ç­–ç•¥çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 0, 'åŒå‘å‡çº¿äº¤å‰ç­–ç•¥', text_color = color.black, bgcolor = color.gray)

    table.cell(infoTable, 0, 1, 'äº¤æ˜“æ–¹å‘', text_color = color.black, bgcolor = color.gray)
    directionColor = tradeDirection == 'çœ‹å¤š' ? color.green : tradeDirection == 'çœ‹ç©º' ? color.red : color.blue
    table.cell(infoTable, 1, 1, tradeDirection, text_color = color.black, bgcolor = directionColor)

    table.cell(infoTable, 0, 2, 'è¶‹åŠ¿åˆ¤æ–­', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 2, strategyTrendUp ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ', text_color = color.black, bgcolor = strategyTrendUp ? color.green : color.red)

    table.cell(infoTable, 0, 3, 'äº¤å‰ä¿¡å·', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 3, goldenCross ? 'é‡‘å‰' : deathCross ? 'æ­»å‰' : 'ç­‰å¾…', text_color = color.black, bgcolor = goldenCross ? color.green : deathCross ? color.red : color.gray)

    table.cell(infoTable, 0, 4, 'ç­–ç•¥å¿«çº¿', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 4, strategyFast, text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 5, 'ç­–ç•¥æ…¢çº¿', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 5, strategySlow, text_color = color.black, bgcolor = color.orange)

    table.cell(infoTable, 0, 6, 'å½“å‰ä»“ä½', text_color = color.black, bgcolor = color.gray)
    positionStatus = strategy.position_size > 0 ? 'å¤šå¤´' : strategy.position_size < 0 ? 'ç©ºå¤´' : 'ç©ºä»“'
    positionBgColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 1, 6, positionStatus, text_color = color.black, bgcolor = positionBgColor)

    table.cell(infoTable, 0, 7, 'ä»“ä½æ¯”ä¾‹', text_color = color.black, bgcolor = color.gray)
    positionRatio = math.abs(strategy.position_size * close / strategy.equity)
    table.cell(infoTable, 1, 7, str.tostring(positionRatio * 100, '#.##') + '%', text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 8, 'å½¢æ€çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    formationStatus = strategy.position_size > 0 ? (close > strategyFastMA ? 'å½¢æ€å®Œå¥½' : 'å½¢æ€ç ´å¿«') : strategy.position_size < 0 ? (close < strategyFastMA ? 'å½¢æ€å®Œå¥½' : 'å½¢æ€ç ´å¿«') : (close > strategyFastMA ? 'å¤šå¤´å½¢æ€' : 'ç©ºå¤´å½¢æ€')
    formationColor = strategy.position_size > 0 ? (close > strategyFastMA ? color.green : color.red) : strategy.position_size < 0 ? (close < strategyFastMA ? color.green : color.red) : (close > strategyFastMA ? color.lime : color.orange)
    table.cell(infoTable, 1, 8, formationStatus, text_color = color.black, bgcolor = formationColor)

    table.cell(infoTable, 0, 9, 'ç¼“å†²åŒºçŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    bufferStatus = ''
    if bufferEnabled and not na(bufferEntryPrice)
        if inBufferZone
            bufferStatus := 'ä¿¡å·å±è”½ä¸­'
        else
            bufferStatus := 'æ­£å¸¸äº¤æ˜“'
    else if bufferValue > 0
        bufferStatus := 'ç­‰å¾…å¼€ä»“'
    else
        bufferStatus := 'å·²å…³é—­'
    
    bufferColor = bufferEnabled and not na(bufferEntryPrice) ? (inBufferZone ? color.red : color.green) : color.gray
    table.cell(infoTable, 1, 9, bufferStatus, text_color = color.black, bgcolor = bufferColor)

    table.cell(infoTable, 0, 10, 'ç¼“å†²åŒºè®¾ç½®', text_color = color.black, bgcolor = color.gray)
    bufferSettingText = ''
    if bufferEnabled and not na(bufferEntryPrice)
        if bufferUnit == '%'
            bufferSettingText := str.tostring(bufferValue, '#.#') + '% [' + str.tostring(bufferLowerBound, '#.##') + ' - ' + str.tostring(bufferUpperBound, '#.##') + ']'
        else
            bufferSettingText := str.tostring(bufferValue, '#.##') + ' [' + str.tostring(bufferLowerBound, '#.##') + ' - ' + str.tostring(bufferUpperBound, '#.##') + ']'
    else
        bufferSettingText := bufferValue > 0 ? 'ç­‰å¾…å¼€ä»“' : 'å…³é—­'
    table.cell(infoTable, 1, 10, bufferSettingText, text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 11, 'Kçº¿åˆ†æ', text_color = color.black, bgcolor = color.gray)
    candleMarkText = ''
    if enableCandleMarking
        if isObviousRise
            candleMarkText := 'ğŸ“ˆ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
        else if isObviousFall
            candleMarkText := 'ğŸ“‰ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
        else
            candleMarkText := 'â¡ï¸ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
    else
        candleMarkText := 'å·²å…³é—­'
    
    candleMarkColor = enableCandleMarking ? (isObviousRise ? color.lime : isObviousFall ? color.red : color.gray) : color.gray
    table.cell(infoTable, 1, 11, candleMarkText, text_color = color.black, bgcolor = candleMarkColor)
    
    // Kçº¿è¯¦ç»†åˆ†æä¿¡æ¯ï¼ˆå½“å¯ç”¨Kçº¿æ ‡è®°æ—¶æ˜¾ç¤ºæ›´å¤šè¡Œï¼‰
    if enableCandleMarking
        // è¯¦ç»†Kçº¿æ•°æ®
        table.cell(infoTable, 0, 12, 'OHLCæ•°æ®', text_color = color.black, bgcolor = color.gray)
        ohlcText = 'O:' + str.tostring(open, '#.##') + ' H:' + str.tostring(high, '#.##') + ' L:' + str.tostring(low, '#.##') + ' C:' + str.tostring(close, '#.##')
        table.cell(infoTable, 1, 12, ohlcText, text_color = color.black, bgcolor = color.blue)
        
        // é‡ä»·å…³ç³»åˆ†æ
        table.cell(infoTable, 0, 13, 'é‡ä»·å…³ç³»', text_color = color.black, bgcolor = color.gray)
        volumePriceText = ''
        volumePriceColor = color.gray
        if isObviousRise and isHighVolume
            volumePriceText := 'ğŸŸ¢ æ¶¨é‡é…åˆ-å¥åº·ä¸Šæ¶¨'
            volumePriceColor := color.lime
        else if isObviousRise and isLowVolume
            volumePriceText := 'ğŸŸ¡ æ¶¨ç¼©é‡-éœ€è¦è­¦æƒ•'
            volumePriceColor := color.yellow
        else if isObviousFall and isHighVolume
            volumePriceText := 'ğŸ”´ è·Œé‡é‡Šæ”¾-ç©ºå¤´å‘åŠ›'
            volumePriceColor := color.red
        else if isObviousFall and isLowVolume
            volumePriceText := 'ğŸŸ  è·Œç¼©é‡-æ€è·Œæœ‰é™'
            volumePriceColor := color.orange
        else
            volumePriceText := 'âšª æ­£å¸¸éœ‡è¡'
        table.cell(infoTable, 1, 13, volumePriceText, text_color = color.black, bgcolor = volumePriceColor)
        
        // æˆäº¤é‡è¯¦ç»†åˆ†æ
        table.cell(infoTable, 0, 14, 'æˆäº¤é‡è¯¦æƒ…', text_color = color.black, bgcolor = color.gray)
        volumeDetailText = str.tostring(volume/avgVolume, '#.##') + 'å€ ('
        if isHighVolume
            volumeDetailText += 'æ”¾é‡>'  + str.tostring(volumeHighThreshold, '#.#') + 'å€)'
        else if isLowVolume
            volumeDetailText += 'ç¼©é‡<' + str.tostring(volumeLowThreshold, '#.#') + 'å€)'
        else
            volumeDetailText += 'æ­£å¸¸é‡)'
        volumeColor = isHighVolume ? color.lime : isLowVolume ? color.orange : color.gray
        table.cell(infoTable, 1, 14, volumeDetailText, text_color = color.black, bgcolor = volumeColor)
        
        // å‡çº¿å…³ç³»åˆ†æ
        table.cell(infoTable, 0, 15, 'å‡çº¿å…³ç³»', text_color = color.black, bgcolor = color.gray)
        maRelationText = 'EMA1è·ç¦»:' + str.tostring(((close - ema1) / ema1) * 100, '#.##') + '% | EMA2è·ç¦»:' + str.tostring(((close - ema2) / ema2) * 100, '#.##') + '%'
        maRelationColor = close > ema1 and close > ema2 ? color.lime : close < ema1 and close < ema2 ? color.red : color.yellow
        table.cell(infoTable, 1, 15, maRelationText, text_color = color.black, bgcolor = maRelationColor)
        
        // è¶‹åŠ¿çŠ¶æ€
        table.cell(infoTable, 0, 16, 'è¶‹åŠ¿çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
        trendText = trendUp ? 'ğŸ“ˆ å¤šå¤´è¶‹åŠ¿ (EMA1>EMA2)' : 'ğŸ“‰ ç©ºå¤´è¶‹åŠ¿ (EMA1<EMA2)'
        trendColor = trendUp ? color.green : color.red
        table.cell(infoTable, 1, 16, trendText, text_color = color.black, bgcolor = trendColor)


