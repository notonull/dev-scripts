//@version=6
strategy('åŒå‡çº¿äº¤æ˜“ç­–ç•¥', overlay = true, margin_long = 100, margin_short = 100, initial_capital = 3000, process_orders_on_close = true)

// === åŸºç¡€å‚æ•°è¾“å…¥ ===
lenSMA1 = input.int(20, title = 'SMA1')
lenEMA1 = input.int(20, title = 'EMA1')
lenSMA2 = input.int(60, title = 'SMA2')
lenEMA2 = input.int(60, title = 'EMA2')
lenSMA3 = input.int(120, title = 'SMA3')
lenEMA3 = input.int(120, title = 'EMA3')

// === æ˜¾ç¤ºæ§åˆ¶ ===
showInfoTable = input.bool(false, title = 'æ˜¾ç¤ºä¿¡æ¯è¡¨æ ¼')
enableMA = input.bool(true, title = 'å¯ç”¨å‡çº¿')
enableMagicNine = input.bool(false, title = 'å¯ç”¨ç¥å¥‡ä¹è½¬')

// === Kçº¿æ ‡è®°è®¾ç½® ===
enableCandleMarking = input.bool(true, title = 'å¯ç”¨Kçº¿æ ‡è®°')
enableVolumeBackground = input.bool(false, title = 'å¯ç”¨é‡ä»·å…³ç³»')
riseThreshold = 2.0  // å›ºå®šé˜ˆå€¼2%
fallThreshold = 2.0  // å›ºå®šé˜ˆå€¼2%





// === å‡çº¿è®¡ç®— ===
sma1 = ta.sma(close, lenSMA1)
ema1 = ta.ema(close, lenEMA1)
sma2 = ta.sma(close, lenSMA2)
ema2 = ta.ema(close, lenEMA2)
sma3 = ta.sma(close, lenSMA3)
ema3 = ta.ema(close, lenEMA3)

// === é¢œè‰²å®šä¹‰ ===
sma1Color = color.rgb(255, 230, 100) // æµ…é»„
ema1Color = color.rgb(200, 160, 0) // æ·±é»„
sma2Color = color.rgb(120, 200, 255) // æµ…è“
ema2Color = color.rgb(0, 80, 200) // æ·±è“
sma3Color = color.rgb(255, 150, 150) // æµ…çº¢
ema3Color = color.rgb(223, 20, 241) // æ·±çº¢

// === ç»˜åˆ¶å‡çº¿ ===
plot(enableMA ? sma1 : na, color = sma1Color, title = 'SMA1', display = display.none)
plot(enableMA ? ema1 : na, color = ema1Color, title = 'EMA1')
plot(enableMA ? sma2 : na, color = sma2Color, title = 'SMA2', display = display.none)
plot(enableMA ? ema2 : na, color = ema2Color, title = 'EMA2')
plot(enableMA ? sma3 : na, color = sma3Color, title = 'SMA3', display = display.none)
plot(enableMA ? ema3 : na, color = ema3Color, title = 'EMA3', display = display.none)

// === Kçº¿å½¢æ€è¯†åˆ« ===
// è®¡ç®—Kçº¿æ¶¨è·Œå¹…
candleChangePercent = (close - open) / open * 100

// === ç¥å¥‡ä¹è½¬TD Sequentialå‚æ•° ===

// === ç¥å¥‡ä¹è½¬æ ¸å¿ƒé€»è¾‘ ===
var int TD = 0
var int TS = 0
var int TDUp = 0
var int TDDn = 0
var bool sell = false
var bool buy = false
var bool sellsetup = false
var bool buysetup = false
var bool sellovershoot = false
var bool sellovershoot1 = false
var bool sellovershoot2 = false
var bool sellovershoot3 = false
var bool buyovershoot = false
var bool buyovershoot1 = false
var bool buyovershoot2 = false
var bool buyovershoot3 = false
var float TDbuyh = na
var float TDbuyl = na
var float TDsellh = na
var float TDselll = na

// Kçº¿ä¿¡æ¯æ˜¾ç¤ºæ§åˆ¶å˜é‡
var bool showKlineInfo = false
var string klineTooltip = ""
var string candleTooltip = ""

if enableMagicNine
    // åŸºç¡€è®¡æ•°é€»è¾‘
    TD := close > close[4] ? nz(TD[1]) + 1 : 0
    TS := close < close[4] ? nz(TS[1]) + 1 : 0

    TDUp := TD - ta.valuewhen(TD < TD[1], TD, 1)
    TDDn := TS - ta.valuewhen(TS < TS[1], TS, 1)

    // Setupè¯†åˆ«é€»è¾‘ï¼ˆjohan.gradinç®—æ³•ï¼‰
    priceflip = ta.barssince(close < close[4])
    sellsetup := close > close[4] and priceflip >= 0
    sell := sellsetup and priceflip == 9
    sellovershoot := sellsetup and priceflip == 13
    sellovershoot1 := sellsetup and priceflip == 14
    sellovershoot2 := sellsetup and priceflip == 15
    sellovershoot3 := sellsetup and priceflip == 16

    priceflip1 = ta.barssince(close > close[4])
    buysetup := close < close[4] and priceflip1 >= 0
    buy := buysetup and priceflip1 == 9
    buyovershoot := buysetup and priceflip1 == 13
    buyovershoot1 := buysetup and priceflip1 == 14
    buyovershoot2 := buysetup and priceflip1 == 15
    buyovershoot3 := buysetup and priceflip1 == 16

    // TDæ”¯æ’‘é˜»åŠ›çº¿
    TDbuyh := ta.valuewhen(buy, high, 0)
    TDbuyl := ta.valuewhen(buy, low, 0)
    TDsellh := ta.valuewhen(sell, high, 0)
    TDselll := ta.valuewhen(sell, low, 0)
else
    // é‡ç½®æ‰€æœ‰TDå˜é‡
    TD := 0
    TS := 0
    TDUp := 0
    TDDn := 0
    sell := false
    buy := false
    sellsetup := false
    buysetup := false
    sellovershoot := false
    sellovershoot1 := false
    sellovershoot2 := false
    sellovershoot3 := false
    buyovershoot := false
    buyovershoot1 := false
    buyovershoot2 := false
    buyovershoot3 := false
    TDbuyh := na
    TDbuyl := na
    TDsellh := na
    TDselll := na

// TD Kçº¿ç€è‰²ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
tdBarColor = color(na)
if enableMagicNine
    if sell
        tdBarColor := #FF0000
    else if buy
        tdBarColor := #00FF00
    else if sellovershoot
        tdBarColor := #FF66A3
    else if sellovershoot1
        tdBarColor := #FF3385
    else if sellovershoot2
        tdBarColor := #FF0066
    else if sellovershoot3
        tdBarColor := #CC0052
    else if buyovershoot
        tdBarColor := #D6FF5C
    else if buyovershoot1
        tdBarColor := #D1FF47
    else if buyovershoot2
        tdBarColor := #B8E62E
    else if buyovershoot3
        tdBarColor := #8FB224

barcolor(tdBarColor, title="TD Sequential Kçº¿ç€è‰²")

// === ç¥å¥‡ä¹è½¬æ•°å­—æ ‡è®°æ˜¾ç¤ºï¼ˆæ™ºèƒ½é¢œè‰²ç®¡ç†ï¼Œå¤±æ•ˆæ•°å­—å˜é»‘ï¼‰ ===
if enableMagicNine
    // ä¸Šæ¶¨æ•°å­—æ ‡è®°
    if TDUp >= 1 and TDUp <= 9 and TDUp[1] != TDUp
        // æ£€æµ‹åºåˆ—å›é€€ï¼šå½“å‰æ•°å­—å°äºå‰ä¸€ä¸ªæ•°å­—(åºåˆ—è¢«æ‰“æ–­)
        if TDUp < TDUp[1] and TDUp[1] >= 1 and TDUp[1] <= 9
            // é¦–å…ˆæ˜¾ç¤ºå¤±æ•ˆçš„æ•°å­—(ç°è‰²) - ä»å½“å‰æ•°å­—+1åˆ°å‰ä¸€ä¸ªæ•°å­—
            if TDUp[1] > TDUp
                for i = TDUp + 1 to TDUp[1]
                    label.new(bar_index, high*1.015, text=str.tostring(i), style=label.style_none, 
                              color=color.new(color.white, 100), textcolor=color.gray, size=size.small)
            // ç„¶åæ˜¾ç¤ºå½“å‰æ•°å­—(ç»¿è‰²)
            label.new(bar_index, high*1.015, text=str.tostring(TDUp), style=label.style_none, 
                      color=color.new(color.white, 100), textcolor=color.green, size=size.small)
        else
            // æ­£å¸¸åºåˆ—ï¼Œæ˜¾ç¤ºç»¿è‰²æ•°å­—
            label.new(bar_index, high*1.015, text=str.tostring(TDUp), style=label.style_none, 
                      color=color.new(color.white, 100), textcolor=color.green, size=size.small)
    
    // ä¸‹è·Œæ•°å­—æ ‡è®°
    if TDDn >= 1 and TDDn <= 9 and TDDn[1] != TDDn
        // æ£€æµ‹åºåˆ—å›é€€ï¼šå½“å‰æ•°å­—å°äºå‰ä¸€ä¸ªæ•°å­—(åºåˆ—è¢«æ‰“æ–­)
        if TDDn < TDDn[1] and TDDn[1] >= 1 and TDDn[1] <= 9
            // é¦–å…ˆæ˜¾ç¤ºå¤±æ•ˆçš„æ•°å­—(ç°è‰²) - ä»å½“å‰æ•°å­—+1åˆ°å‰ä¸€ä¸ªæ•°å­—
            if TDDn[1] > TDDn
                for i = TDDn + 1 to TDDn[1]
                    label.new(bar_index, low*0.985, text=str.tostring(i), style=label.style_none, 
                              color=color.new(color.white, 100), textcolor=color.gray, size=size.small)
            // ç„¶åæ˜¾ç¤ºå½“å‰æ•°å­—(çº¢è‰²)
            label.new(bar_index, low*0.985, text=str.tostring(TDDn), style=label.style_none, 
                      color=color.new(color.white, 100), textcolor=color.red, size=size.small)
        else
            // æ­£å¸¸åºåˆ—ï¼Œæ˜¾ç¤ºçº¢è‰²æ•°å­—
            label.new(bar_index, low*0.985, text=str.tostring(TDDn), style=label.style_none, 
                      color=color.new(color.white, 100), textcolor=color.red, size=size.small)


// === åŸºç¡€æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ï¼ˆç”¨äºé‡ä»·å…³ç³»ï¼‰ ===
avgVolume = ta.sma(volume, 20)

// é‡ä»·åˆ¤æ–­é˜ˆå€¼
volumeHighThreshold = 1.5  // é«˜æˆäº¤é‡é˜ˆå€¼å€æ•°
volumeLowThreshold = 0.7   // ä½æˆäº¤é‡é˜ˆå€¼å€æ•°

// é‡ä»·èƒŒæ™¯åˆ¤æ–­
isHighVolume = volume >= avgVolume * volumeHighThreshold
isLowVolume = volume <= avgVolume * volumeLowThreshold

// åŸæœ‰é€»è¾‘ä¿æŒ
isObviousRise = enableCandleMarking and candleChangePercent >= riseThreshold and close > open
isObviousFall = enableCandleMarking and candleChangePercent <= -fallThreshold and close < open

// === Kçº¿ä¿¡æ¯æ ‡è®°ï¼ˆåœ†ç‚¹+è¯¦ç»†åˆ†ææç¤ºï¼Œæ™ºèƒ½ä½ç½®é¿è®©ï¼‰ ===
if isObviousRise
    // æœ‰ä¹è½¬æ—¶åœ†ç‚¹æ”¾è¿œä¸€äº›ï¼Œæ²¡æœ‰ä¹è½¬æ—¶åœ†ç‚¹é è¿‘
    risePosition = enableMagicNine ? low*0.95 : low*0.985
    label.new(bar_index, risePosition, text="â—", style=label.style_none, 
              color=color.new(color.white, 100), textcolor=color.new(color.green, 0), 
              size=size.normal, xloc=xloc.bar_index, tooltip=candleTooltip)
if isObviousFall
    // æœ‰ä¹è½¬æ—¶åœ†ç‚¹æ”¾è¿œä¸€äº›ï¼Œæ²¡æœ‰ä¹è½¬æ—¶åœ†ç‚¹é è¿‘
    fallPosition = enableMagicNine ? high*1.05 : high*1.015
    label.new(bar_index, fallPosition, text="â—", style=label.style_none, 
              color=color.new(color.white, 100), textcolor=color.new(color.red, 0), 
              size=size.normal, xloc=xloc.bar_index, tooltip=candleTooltip)

// è¶‹åŠ¿åˆ¤æ–­ï¼ˆä¸´æ—¶ä½¿ç”¨å›ºå®šå‡çº¿ï¼Œç¨åä¼šæ›´æ–°ä¸ºç­–ç•¥å‡çº¿ï¼‰
trendUp = ema1 > ema2
trendDown = ema1 < ema2

// è®¡ç®—Kçº¿å®ä½“å¤§å°ï¼ˆç”¨äºæ ‡è®°å¼ºåº¦åˆ¤æ–­ï¼‰
candleBodySize = math.abs(close - open)
avgBodySize = ta.sma(candleBodySize, 20) // 20å‘¨æœŸå¹³å‡å®ä½“å¤§å°
isStrongCandle = candleBodySize > avgBodySize * 1.5 // å®ä½“å¤§äºå¹³å‡å€¼1.5å€è§†ä¸ºå¼ºåŠ¿Kçº¿

// è®¡ç®—èƒŒæ™¯æ¸å˜é€æ˜åº¦ï¼ˆæ ¹æ®æ¶¨è·Œå¹…å¼ºåº¦ï¼‰
riseIntensity = 0.0
fallIntensity = 0.0

if enableCandleMarking
    if isObviousRise // æ™®é€šä¸Šæ¶¨
        riseIntensity := math.round(math.min(math.abs(candleChangePercent) * 5, 35))

    if isObviousFall // æ™®é€šä¸‹è·Œ
        fallIntensity := math.round(math.min(math.abs(candleChangePercent) * 5, 35))

// === Kçº¿å½¢æ€æ ‡è®° ===
// Kçº¿èƒŒæ™¯æ¸å˜ï¼ˆæ ¹æ®æ¶¨è·Œå¹…å¼ºåº¦æ˜¾ç¤ºï¼‰
traditionalBgColor = riseIntensity > 0 ? color.new(color.green, 100 - riseIntensity) :
                     fallIntensity > 0 ? color.new(color.red, 100 - fallIntensity) : na

// é‡ä»·å…³ç³»èƒŒæ™¯ï¼ˆä»…åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰
var color volumePriceBgColor = na
volumePriceBgColor := na
if enableVolumeBackground and enableCandleMarking
    if isObviousRise and isHighVolume
        volumePriceBgColor := color.new(color.lime, 80)  // æ¶¨é‡
    else if isObviousFall and isHighVolume
        volumePriceBgColor := color.new(color.red, 80)   // è·Œé‡
    else if isObviousRise and isLowVolume
        volumePriceBgColor := color.new(color.orange, 85) // æ¶¨ç¼©é‡
    else if isObviousFall and isLowVolume
        volumePriceBgColor := color.new(color.purple, 85) // è·Œç¼©é‡

// åº”ç”¨èƒŒæ™¯é¢œè‰²
// å½“å¯ç”¨é‡ä»·å…³ç³»æ—¶ï¼Œä¼˜å…ˆæ˜¾ç¤ºé‡ä»·èƒŒæ™¯ï¼Œå¦åˆ™æ˜¾ç¤ºä¼ ç»Ÿæ¶¨è·ŒèƒŒæ™¯
finalBgColor = enableVolumeBackground ? (not na(volumePriceBgColor) ? volumePriceBgColor : traditionalBgColor) : na
bgcolor(finalBgColor, title = 'Kçº¿èƒŒæ™¯')

// === æ ¼å¼åŒ–å‡½æ•°å®šä¹‰ï¼ˆæå‰å®šä¹‰ï¼‰ ===
// æ ¼å¼åŒ–æˆäº¤é‡å•ä½
formatVolume(vol) =>
    if vol >= 100000000
        str.tostring(vol/100000000, "#.##") + "äº¿"
    else if vol >= 10000
        str.tostring(vol/10000, "#.##") + "ä¸‡"
    else
        str.tostring(vol, "#")

// æ ¼å¼åŒ–ä»·æ ¼å•ä½
formatPrice(price) =>
    if price >= 1000
        str.tostring(price, "#.##") + "å…ƒ"
    else if price >= 100
        str.tostring(price, "#.###") + "å…ƒ"
    else if price >= 10
        str.tostring(price, "#.####") + "å…ƒ"
    else
        str.tostring(price, "#.#####") + "å…ƒ"

// === Kçº¿æ‚¬åœä¿¡æ¯åŠŸèƒ½ ===
// æ„å»ºKçº¿è¯¦ç»†åˆ†æä¿¡æ¯ç”¨äºé¼ æ ‡æ‚¬åœæ˜¾ç¤º
if enableCandleMarking
    candleTooltip := "=== Kçº¿åˆ†æ ===\n"

    // åŸºç¡€Kçº¿ä¿¡æ¯
    candleTooltip += "å¼€ç›˜ä»·: " + str.tostring(open, "#.####") + "\n"
    candleTooltip += "æœ€é«˜ä»·: " + str.tostring(high, "#.####") + "\n"
    candleTooltip += "æœ€ä½ä»·: " + str.tostring(low, "#.####") + "\n"
    candleTooltip += "æ”¶ç›˜ä»·: " + str.tostring(close, "#.####") + "\n"
    candleTooltip += "æ¶¨è·Œå¹…: " + str.tostring(candleChangePercent, "#.##") + "%\n"

    // Kçº¿ç±»å‹æè¿°
    if isObviousRise
        candleTooltip += "\nğŸ“ˆ æ˜æ˜¾ä¸Šæ¶¨ä¿¡å·"
        candleTooltip += "\næ¶¨å¹…è¶…è¿‡ " + str.tostring(riseThreshold, "#.#") + "% é˜ˆå€¼"
    else if isObviousFall
        candleTooltip += "\nğŸ“‰ æ˜æ˜¾ä¸‹è·Œä¿¡å·"
        candleTooltip += "\nè·Œå¹…è¶…è¿‡ " + str.tostring(fallThreshold, "#.#") + "% é˜ˆå€¼"
    else
        candleTooltip += "\nâ¡ï¸ æ­£å¸¸æ³¢åŠ¨"
        candleTooltip += "\næ³¢åŠ¨å¹…åº¦åœ¨æ­£å¸¸èŒƒå›´å†…"

    // æˆäº¤é‡åˆ†æ
    candleTooltip += "\n\n=== æˆäº¤é‡åˆ†æ ==="
    candleTooltip += "\nå½“å‰æˆäº¤é‡: " + formatVolume(volume) + "\n"
    candleTooltip += "å¹³å‡æˆäº¤é‡: " + formatVolume(avgVolume) + "\n"
    candleTooltip += "é‡èƒ½å€æ•°: " + str.tostring(volume/avgVolume, "#.##") + "å€\n"

    if isHighVolume
        candleTooltip += "ğŸ“Š é«˜æˆäº¤é‡ (>" + str.tostring(volumeHighThreshold, "#.#") + "å€å¹³å‡é‡)"
    else if isLowVolume
        candleTooltip += "ğŸ“Š ä½æˆäº¤é‡ (<" + str.tostring(volumeLowThreshold, "#.#") + "å€å¹³å‡é‡)"
    else
        candleTooltip += "ğŸ“Š æ­£å¸¸æˆäº¤é‡"

    // é«˜çº§æŠ€æœ¯åˆ†æ
    candleTooltip += "\n\n=== é«˜çº§æŠ€æœ¯åˆ†æ ==="
    
    // é‡èƒ½ç»“æ„åˆ†æ
    candleTooltip += "\nã€é‡èƒ½ç»“æ„ã€‘ï¼š"
    if isObviousRise and isHighVolume and candleChangePercent < 1.0
        candleTooltip += "æ»æ¶¨æ”¾é‡"
    else if isObviousFall and isLowVolume and candleChangePercent > -1.0
        candleTooltip += "ç¼©é‡ç­‘åº•" 
    else if isObviousRise and isHighVolume
        candleTooltip += "æ”¾é‡çªç ´"
    else if isObviousFall and isHighVolume
        candleTooltip += "æ”¾é‡ç ´ä½"
    else if isLowVolume
        candleTooltip += "ç¼©é‡ç›˜æ•´"
    else
        candleTooltip += "æ­£å¸¸æ¢æ‰‹"
    
    // åŠ¨èƒ½æŒ‡æ ‡åˆ†æ
    macd_line = ta.ema(close, 12) - ta.ema(close, 26)
    signal_line = ta.ema(macd_line, 9)
    macd_hist = macd_line - signal_line
    
    candleTooltip += "\nã€åŠ¨èƒ½æŒ‡æ ‡ã€‘ï¼š"
    if macd_hist > 0 and macd_hist < macd_hist[1] and close > close[5] and macd_line < macd_line[5]
        candleTooltip += "MACDé¡¶èƒŒç¦»"
    else if macd_hist < 0 and macd_hist > macd_hist[1] and close < close[5] and macd_line > macd_line[5]
        candleTooltip += "MACDåº•èƒŒç¦»"
    else if macd_hist > 0 and macd_hist > macd_hist[1]
        candleTooltip += "MACDå¤šå¤´åŠ é€Ÿ"
    else if macd_hist < 0 and macd_hist < macd_hist[1]
        candleTooltip += "MACDç©ºå¤´åŠ é€Ÿ"
    else
        candleTooltip += "MACDéœ‡è¡"
    
    // RSIåˆ†æ
    rsi = ta.rsi(close, 14)
    candleTooltip += "\nã€RSIã€‘ï¼š"
    if rsi > 70
        candleTooltip += "é«˜ä½é’åŒ–(RSI:" + str.tostring(rsi, "#.1") + ")"
    else if rsi < 30
        candleTooltip += "ä½ä½åå¼¹(RSI:" + str.tostring(rsi, "#.1") + ")"
    else if rsi > 50
        candleTooltip += "å¤šå¤´åŒºåŸŸ(RSI:" + str.tostring(rsi, "#.1") + ")"
    else
        candleTooltip += "ç©ºå¤´åŒºåŸŸ(RSI:" + str.tostring(rsi, "#.1") + ")"
    
    // èµ„é‡‘æµå‘åˆ†æ(åŸºäºé‡ä»·å…³ç³»æ¨¡æ‹Ÿ)
    candleTooltip += "\nã€èµ„é‡‘æµå‘ã€‘ï¼š"
    if isObviousRise and isHighVolume
        candleTooltip += "ä¸»åŠ›å‡€æµå…¥"
    else if isObviousFall and isHighVolume
        candleTooltip += "ä¸»åŠ›å‡€æµå‡º"
    else if isObviousRise and isLowVolume
        candleTooltip += "èµ„é‡‘è°¨æ…çœ‹å¤š"
    else if isObviousFall and isLowVolume
        candleTooltip += "èµ„é‡‘ææ…Œæœ‰é™"
    else
        candleTooltip += "èµ„é‡‘è§‚æœ›"
    
    // OBVåˆ†æ(ç®€åŒ–ç‰ˆ)
    candleTooltip += "\nã€OBVã€‘ï¼š"
    obvChange = close > close[1] ? volume : close < close[1] ? -volume : 0
    obvTrend = ta.sma(obvChange, 5)
    if math.abs(obvTrend) < volume * 0.1
        candleTooltip += "æ¨ªç›˜"
    else if obvTrend > 0
        candleTooltip += "ç¿»å‡"
    else
        candleTooltip += "èµ°å¼±"
    
    // æ³¢åŠ¨ç‡åˆ†æ(ATR)
    atr = ta.atr(14)
    atrChange = (atr - atr[1]) / atr[1] * 100
    candleTooltip += "\nã€æ³¢åŠ¨ç‡ã€‘ï¼š"
    if atrChange < -5
        candleTooltip += "ATRä¸‹é™(æ”¶æ•›)â†’å‡†å¤‡çˆ†å‘"
    else if atrChange > 10
        candleTooltip += "ATRé£™å‡â†’å¸‚åœºæ¿€çƒˆ"
    else if atr < ta.sma(atr, 20) * 0.8
        candleTooltip += "ä½æ³¢åŠ¨â†’è“„åŠ¿å¾…å‘"
    else
        candleTooltip += "æ­£å¸¸æ³¢åŠ¨"


// === Kçº¿æ ‡è®°æ˜¾ç¤º ===
// åœ¨Kçº¿ä¸‹æ–¹æ˜¾ç¤ºæ ‡è®°ï¼Œé¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†æç¤ºæ¡†
if enableCandleMarking
    // æ·»åŠ æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
    macd_line = ta.ema(close, 12) - ta.ema(close, 26)
    signal_line = ta.ema(macd_line, 9)
    rsi = ta.rsi(close, 14)
    k = ta.stoch(close, high, low, 14)
    d = ta.sma(k, 3)

    // Kçº¿å½¢æ€è¯†åˆ«
    candlePattern = ""
    upperShadowRatio = close > open ? (high - close) / (close - open) : (high - open) / (open - close)
    lowerShadowRatio = close > open ? (close - low) / (close - open) : (open - low) / (open - close)
    
    if candleBodySize > avgBodySize * 2
        if isObviousRise
            candlePattern := "é•¿é˜³çº¿(å®ä½“>" + str.tostring(avgBodySize * 2, "#.##") + ")"
        else if isObviousFall
            candlePattern := "é•¿é˜´çº¿(å®ä½“>" + str.tostring(avgBodySize * 2, "#.##") + ")"
        else
            candlePattern := "å¤§å®ä½“Kçº¿(æ¶¨è·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%)"
    else if math.abs(candleChangePercent) < 0.3
        candlePattern := "åå­—æ˜Ÿ(æ³¢å¹…<0.3%)"
    else if close > open and upperShadowRatio > 2
        candlePattern := "ä¸ŠåŠçº¿(ä¸Šå½±/å®ä½“>" + str.tostring(upperShadowRatio, "#.1") + "å€)"
    else if close < open and lowerShadowRatio > 2
        candlePattern := "é”¤å¤´çº¿(ä¸‹å½±/å®ä½“>" + str.tostring(lowerShadowRatio, "#.1") + "å€)"
    else if isObviousRise
        candlePattern := "é˜³çº¿(+" + str.tostring(candleChangePercent, "#.##") + "%)"
    else if isObviousFall
        candlePattern := "é˜´çº¿(" + str.tostring(candleChangePercent, "#.##") + "%)"
    else
        candlePattern := "æ™®é€šKçº¿(Â±" + str.tostring(math.abs(candleChangePercent), "#.##") + "%)"

    // æˆäº¤é‡æè¿°
    volumeDesc = ""
    volumeChangePercent = volume[1] > 0 ? (volume - volume[1]) / volume[1] * 100 : 0

    if isHighVolume
        volumeDesc := "æ”¾é‡" + str.tostring(math.abs(volumeChangePercent), "#.1") + "%"
        if isObviousRise
            volumeDesc += "ï¼Œé‡ä»·é½å‡(æ¶¨" + str.tostring(candleChangePercent, "#.##") + "%)"
        else if isObviousFall
            volumeDesc += "ï¼Œé‡å¢ä»·è·Œ(è·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%)"
        else
            volumeDesc += "ï¼Œé‡æ¯”" + str.tostring(volume/avgVolume, "#.##")
    else if isLowVolume
        volumeDesc := "ç¼©é‡" + str.tostring(math.abs(volumeChangePercent), "#.1") + "%"
        if isObviousFall
            volumeDesc += "æ€è·Œ(è·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%)"
        else
            volumeDesc += "ï¼Œé‡æ¯”" + str.tostring(volume/avgVolume, "#.##")
    else
        volumeDesc := "æˆäº¤é‡æ­£å¸¸(é‡æ¯”" + str.tostring(volume/avgVolume, "#.##") + ")"

    // å‡çº¿ç»“æ„æè¿°
    maStructure = ""
    ema20_60_diff = (ema1 - ema2) / ema2 * 100
    ema60_120_diff = (ema2 - ema3) / ema3 * 100
    price_ema20_diff = (close - ema1) / ema1 * 100
    
    if ema1 > ema2 and ema2 > ema3
        maStructure := "å¤šå¤´æ’åˆ—ï¼šEMA20æ¯”EMA60é«˜" + str.tostring(math.abs(ema20_60_diff), "#.##") + "%"
    else if ema1 < ema2 and ema2 < ema3
        maStructure := "ç©ºå¤´æ’åˆ—ï¼šEMA20æ¯”EMA60ä½" + str.tostring(math.abs(ema20_60_diff), "#.##") + "%"
    else if close < ema1
        if close[1] >= ema1[1]
            maStructure := "è·Œç ´EMA20æ”¯æ’‘(è·ç¦»-" + str.tostring(math.abs(price_ema20_diff), "#.##") + "%)"
        else
            maStructure := "æŒç»­è¿è¡Œåœ¨EMA20ä¸‹æ–¹(-" + str.tostring(math.abs(price_ema20_diff), "#.##") + "%)"
    else if close > ema2
        if close[1] <= ema2[1]
            maStructure := "çªç ´EMA60é˜»åŠ›(è·ç¦»+" + str.tostring(price_ema20_diff, "#.##") + "%)"
        else
            maStructure := "æŒç»­è¿è¡Œåœ¨EMA60ä¸Šæ–¹(+" + str.tostring(price_ema20_diff, "#.##") + "%)"
    else
        maStructure := "å‡çº¿ç²˜åˆ(20-60æ—¥çº¿å·®è·" + str.tostring(math.abs(ema20_60_diff), "#.##") + "%)"

    // æŠ€æœ¯æŒ‡æ ‡æè¿°
    techIndicators = ""
    macd_strength = math.abs(macd_line - signal_line)
    histogram = macd_line - signal_line
    
    if macd_line > signal_line and macd_line[1] <= signal_line[1]
        techIndicators := "MACDé‡‘å‰çªç ´(DIF:" + str.tostring(macd_line, "#.####") + " DEA:" + str.tostring(signal_line, "#.####") + " æŸ±:" + str.tostring(histogram, "#.####") + ")"
    else if macd_line < signal_line and macd_line[1] >= signal_line[1]
        techIndicators := "MACDæ­»å‰è·Œç ´(DIF:" + str.tostring(macd_line, "#.####") + " DEA:" + str.tostring(signal_line, "#.####") + " æŸ±:" + str.tostring(histogram, "#.####") + ")"
    else if rsi > 80
        techIndicators := "RSIä¸¥é‡è¶…ä¹°(" + str.tostring(rsi, "#.1") + ">80,é«˜ä½é£é™©)"
    else if rsi > 70
        techIndicators := "RSIè¶…ä¹°åŒº(" + str.tostring(rsi, "#.1") + ">70,è°¨æ…è¿½æ¶¨)"
    else if rsi < 20
        techIndicators := "RSIä¸¥é‡è¶…å–(" + str.tostring(rsi, "#.1") + "<20,ç­‘åº•æœºä¼š)"
    else if rsi < 30
        techIndicators := "RSIè¶…å–åŒº(" + str.tostring(rsi, "#.1") + "<30,å…³æ³¨åå¼¹)"
    else if rsi > 50 and rsi[1] <= 50
        techIndicators := "RSIçªç ´ä¸­çº¿(" + str.tostring(rsi, "#.1") + ">50,è½¬å¼ºä¿¡å·)"
    else if rsi < 50 and rsi[1] >= 50
        techIndicators := "RSIè·Œç ´ä¸­çº¿(" + str.tostring(rsi, "#.1") + "<50,è½¬å¼±ä¿¡å·)"
    else if k > d and k[1] <= d[1]
        techIndicators := "KDJé‡‘å‰å‘ä¸Š(K:" + str.tostring(k, "#.1") + ">D:" + str.tostring(d, "#.1") + ",ä¹°å…¥ä¿¡å·)"
    else if k < d and k[1] >= d[1]
        techIndicators := "KDJæ­»å‰å‘ä¸‹(K:" + str.tostring(k, "#.1") + "<D:" + str.tostring(d, "#.1") + ",å–å‡ºä¿¡å·)"
    else if k > 80 and d > 80
        techIndicators := "KDJè¶…ä¹°é’åŒ–(K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ",é«˜ä½éœ‡è¡)"
    else if k < 20 and d < 20
        techIndicators := "KDJè¶…å–é’åŒ–(K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ",ä½ä½ç›˜æ•´)"
    else
        techIndicators := "æŒ‡æ ‡ä¸­æ€§å¹³è¡¡(RSI:" + str.tostring(rsi, "#.1") + " K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ")"

    // æ”¯æ’‘é˜»åŠ›ä½åˆ†æ
    supportLevel = math.min(low[1], low[2], low[3])  // è¿‘æœŸä½ç‚¹
    resistanceLevel = math.max(high[1], high[2], high[3])  // è¿‘æœŸé«˜ç‚¹
    
    supportDistance = (close - supportLevel) / supportLevel * 100
    resistanceDistance = (resistanceLevel - close) / close * 100
    ema20Distance = (close - ema1) / ema1 * 100
    ema60Distance = (close - ema2) / ema2 * 100

    supportDesc = ""
    resistanceDesc = ""

    if close <= supportLevel * 1.01  // æ¥è¿‘æ”¯æ’‘ä½
        if supportDistance > 0
            supportDesc := "çªç ´å‰ä½æ”¯æ’‘" + formatPrice(supportLevel) + "(çªç ´+" + str.tostring(supportDistance, "#.##") + "%)"
        else
            supportDesc := "æµ‹è¯•å‰ä½æ”¯æ’‘" + formatPrice(supportLevel) + "(è·ç¦»" + str.tostring(supportDistance, "+#.##;-#.##") + "%)"
    else if close > ema1
        supportDesc := "ç«™ç¨³EMA20æ”¯æ’‘" + formatPrice(ema1) + "(è·ç¦»+" + str.tostring(ema20Distance, "#.##") + "%)"
    else if close > ema2
        supportDesc := "å›è°ƒè‡³EMA60æ”¯æ’‘" + formatPrice(ema2) + "(è·ç¦»+" + str.tostring(ema60Distance, "#.##") + "%)"
    else
        supportDesc := "è·Œç ´å‡çº¿æ”¯æ’‘ï¼Œå…³æ³¨" + formatPrice(supportLevel) + "(è·ç¦»" + str.tostring(supportDistance, "+#.##;-#.##") + "%)"

    if close >= resistanceLevel * 0.99  // æ¥è¿‘é˜»åŠ›ä½
        if resistanceDistance < 0
            resistanceDesc := "çªç ´å‰é«˜é˜»åŠ›" + formatPrice(resistanceLevel) + "(çªç ´+" + str.tostring(math.abs(resistanceDistance), "#.##") + "%)"
        else
            resistanceDesc := "å†²å‡»å‰é«˜é˜»åŠ›" + formatPrice(resistanceLevel) + "(è·ç¦»" + str.tostring(resistanceDistance, "#.##") + "%)"
    else if resistanceDistance > 5
        resistanceDesc := "è¿œç¦»é˜»åŠ›ä½" + formatPrice(resistanceLevel) + "(è·ç¦»+" + str.tostring(resistanceDistance, "#.##") + "%)"
    else
        resistanceDesc := "ä¸´è¿‘é˜»åŠ›ä½" + formatPrice(resistanceLevel) + "(è·ç¦»+" + str.tostring(resistanceDistance, "#.##") + "%)"

    // å¢åŠ OBVè®¡ç®—ç”¨äºèƒŒç¦»åˆ†æ
    obv = ta.cum(math.sign(ta.change(close)) * volume)
    obv_ma = ta.sma(obv, 5)
    
    // èƒŒç¦»åˆ†æ
    macd_divergence = ""
    price_higher = high > high[5]
    price_lower = low < low[5]
    macd_higher = macd_line > macd_line[5]
    macd_lower = macd_line < macd_line[5]
    
    if price_higher and not macd_higher
        macd_divergence := "MACDé¡¶èƒŒç¦»"
    else if price_lower and not macd_lower
        macd_divergence := "MACDåº•èƒŒç¦»"
    
    // è®¡ç®—é‡æ¯”ç”¨äºåç»­åˆ†æ
    volumeRatio = volume > 0 and avgVolume > 0 ? volume / avgVolume : 1
    
    // ç»¼åˆä¿¡å·è¯†åˆ«
    signal_pattern = ""
    
    // 1. é˜¶æ®µé¡¶éƒ¨ä¿¡å·ï¼šä»·å‡é‡ç¼© + MACDé¡¶èƒŒç¦» + RSI>80 + OBVèµ°å¹³
    if isObviousRise and isLowVolume and macd_divergence == "MACDé¡¶èƒŒç¦»" and rsi > 80 and math.abs(ta.change(obv_ma)) < avgVolume * 0.1
        signal_pattern := "ã€é˜¶æ®µé¡¶éƒ¨ã€‘ä»·å‡é‡ç¼©+" + macd_divergence + "+RSIè¶…ä¹°(" + str.tostring(rsi, "#.1") + ">80)+OBVèµ°å¹³ï¼Œä¸»åŠ›å‡ºè´§é˜¶æ®µ"
    
    // 2. å‡çªç ´ä¿¡å·ï¼šæ”¾é‡é•¿ä¸Šå½± + éšåç¼©é‡é˜´çº¿
    else if isHighVolume and upperShadowRatio > 2 and close < open
        signal_pattern := "ã€å‡çªç ´é™·é˜±ã€‘æ”¾é‡é•¿ä¸Šå½±(ä¸Šå½±/å®ä½“>" + str.tostring(upperShadowRatio, "#.1") + "å€)+é‡æ¯”" + str.tostring(volumeRatio, "#.##") + "ï¼Œè¯±å¤šé™·é˜±"
    
    // 3. ä¸»å‡å¯åŠ¨ï¼šæ”¾é‡çªç ´å¹³å° + å‡çº¿å¤šå¤´ + MACDç¿»çº¢
    else if isHighVolume and isObviousRise and ema1 > ema2 and ema2 > ema3 and macd_line > 0 and macd_line > signal_line
        signal_pattern := "ã€ä¸»å‡å¯åŠ¨ã€‘æ”¾é‡çªç ´(é‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")+å‡çº¿å¤šå¤´æ’åˆ—+MACDç¿»çº¢(" + str.tostring(macd_line, "#.####") + ">0)ï¼Œä¸»å‡æµªç¡®è®¤"
    
    // 4. ç­‘åº•é˜¶æ®µï¼šç¼©é‡é˜´çº¿ â†’ æ”¾é‡é˜³çº¿ + MACDåº•èƒŒç¦»
    else if isLowVolume and isObviousFall and macd_divergence == "MACDåº•èƒŒç¦»"
        signal_pattern := "ã€ç­‘åº•é˜¶æ®µã€‘ç¼©é‡é˜´çº¿(é‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")+" + macd_divergence + "ï¼Œå¸ç­¹å®Œæˆä¿¡å·"
    
    // 5. çœŸåè½¬ï¼šOBVçªç ´å‰é«˜ + RSIä¸Šç©¿50 + å‡çº¿æ‰­è½¬
    else if obv > ta.highest(obv, 20) and rsi > 50 and rsi[1] <= 50 and ema1 > ema1[1] and ema1[1] <= ema1[2]
        signal_pattern := "ã€çœŸåè½¬ç¡®è®¤ã€‘OBVçªç ´å‰é«˜+RSIä¸Šç©¿50(" + str.tostring(rsi, "#.1") + ">50)+å‡çº¿æ‰­è½¬ï¼Œè¶‹åŠ¿åè½¬ç¡®è®¤"
    
    // 6. é‡ä»·èƒŒç¦»ï¼šä»·æ ¼æ–°é«˜ä½†æˆäº¤é‡èç¼©
    else if high > ta.highest(high, 10) and volume < ta.sma(volume, 5) * 0.8
        signal_pattern := "ã€é‡ä»·èƒŒç¦»ã€‘åˆ›æ–°é«˜(" + formatPrice(high) + ")ä½†æˆäº¤é‡èç¼©(é‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œè­¦æƒ•å›è°ƒé£é™©"
    
    // 7. åº•éƒ¨æ”¾é‡ï¼šä½ä½æ”¾é‡é˜³çº¿ + MACDé‡‘å‰
    else if low <= ta.lowest(low, 10) * 1.05 and isHighVolume and isObviousRise and macd_line > signal_line and macd_line[1] <= signal_line[1]
        signal_pattern := "ã€åº•éƒ¨æ”¾é‡ã€‘ä½ä½æ”¾é‡é˜³çº¿(æ¶¨" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")+MACDé‡‘å‰ï¼Œç­‘åº•æˆåŠŸ"
    
    // 8. é«˜ä½ç¼©é‡ï¼šé«˜ä½ç¼©é‡é˜´çº¿é¢„è­¦
    else if high >= ta.highest(high, 10) * 0.95 and isLowVolume and isObviousFall
        signal_pattern := "ã€é«˜ä½ç¼©é‡ã€‘é«˜ä½ç¼©é‡é˜´çº¿(è·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œè°¨é˜²æ·±åº¦å›è°ƒ"
    
    // ç»¼åˆç»“è®º
    conclusion = ""
    priceStrength = math.abs(candleChangePercent)
    
    // ä¼˜å…ˆæ˜¾ç¤ºå¤åˆä¿¡å·
    if signal_pattern != ""
        conclusion := signal_pattern
    else
        // æ·»åŠ æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ç»„åˆä¿¡å·
        if macd_line > signal_line and macd_line[1] <= signal_line[1] and k > d and k[1] <= d[1] and rsi > 50
            conclusion := "ã€å¤šé‡é‡‘å‰å…±æŒ¯ã€‘MACDé‡‘å‰(" + str.tostring(macd_line, "#.####") + ")+KDJé‡‘å‰(K:" + str.tostring(k, "#.1") + ">D:" + str.tostring(d, "#.1") + ")+RSIå¼ºåŠ¿(" + str.tostring(rsi, "#.1") + ">50)ï¼Œå¼ºçƒˆçœ‹æ¶¨"
        
        else if macd_line < signal_line and macd_line[1] >= signal_line[1] and k < d and k[1] >= d[1] and rsi < 50
            conclusion := "ã€å¤šé‡æ­»å‰å…±æŒ¯ã€‘MACDæ­»å‰(" + str.tostring(macd_line, "#.####") + ")+KDJæ­»å‰(K:" + str.tostring(k, "#.1") + "<D:" + str.tostring(d, "#.1") + ")+RSIå¼±åŠ¿(" + str.tostring(rsi, "#.1") + "<50)ï¼Œå¼ºçƒˆçœ‹è·Œ"
        
        else if rsi > 80 and k > 80 and d > 80 and isObviousRise and isLowVolume
            conclusion := "ã€è¶…ä¹°é’åŒ–ã€‘RSIè¶…ä¹°(" + str.tostring(rsi, "#.1") + ">80)+KDJè¶…ä¹°(K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ")+ä»·å‡é‡ç¼©ï¼Œé¡¶éƒ¨é£é™©æé«˜"
        
        else if rsi < 20 and k < 20 and d < 20 and isObviousFall and isLowVolume
            conclusion := "ã€è¶…å–é’åŒ–ã€‘RSIè¶…å–(" + str.tostring(rsi, "#.1") + "<20)+KDJè¶…å–(K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ")+ç¼©é‡ä¸‹è·Œï¼Œåº•éƒ¨æœºä¼šæ˜¾ç°"
        
        else
            // åˆ¤æ–­ç­‘é¡¶ç­‘åº•ä¿¡å·å¼ºåº¦
            signalStrength = priceStrength * volumeRatio
            
            if trendUp and isObviousRise and isHighVolume
                if candleChangePercent > 3 and volumeRatio > 2
                    conclusion := "å¼ºåŠ¿ç­‘åº•å®Œæˆï¼šæš´æ¶¨" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œçˆ†é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œçªç ´" + formatPrice(resistanceLevel) + "å¼ºåŠ¿çœ‹æ¶¨"
                else
                    conclusion := "ç­‘åº•å›å‡ç¡®è®¤ï¼šä¸Šæ¶¨" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œæ”¾é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œçªç ´" + formatPrice(resistanceLevel) + "çœ‹æ¶¨"
            else if trendDown and isObviousFall and isHighVolume
                if math.abs(candleChangePercent) > 3 and volumeRatio > 2
                    conclusion := "ç­‘é¡¶æš´è·Œç¡®è®¤ï¼šé‡æŒ«" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œææ…ŒæŠ›å”®é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œè·Œç ´" + formatPrice(supportLevel) + "çœ‹ç©º"
                else
                    conclusion := "ç­‘é¡¶ä¸‹è·Œä¿¡å·ï¼šä¸‹è·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œæ”¾é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œè·Œç ´" + formatPrice(supportLevel) + "çœ‹è·Œ"
            else if isObviousRise and isLowVolume
                conclusion := "åå¼¹ä¹åŠ›è­¦å‘Šï¼šæ¶¨" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œä½†ç¼©é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œé‡ä»·èƒŒç¦»è°¨æ…è¿½é«˜"
            else if isObviousFall and isLowVolume
                conclusion := "ç¼©é‡æ€è·Œæœ‰é™ï¼šè·Œ" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œå…³æ³¨" + formatPrice(supportLevel) + "æ”¯æ’‘åå¼¹"
            else if priceStrength < 0.5 and volumeRatio < 0.8
                conclusion := "æ¨ªç›˜ç¼©é‡æ•´ç†ï¼šæ³¢å¹…" + str.tostring(priceStrength, "#.##") + "%ï¼Œç¼©é‡" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œè“„åŠ¿å¾…å‘ç­‰æ–¹å‘"
            else if signalStrength > 3
                conclusion := "éœ‡è¡åŠ å‰§ä¿¡å·ï¼šæ³¢å¹…" + str.tostring(priceStrength, "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œå…³æ³¨çªç ´æ–¹å‘"
            else
                conclusion := "å¸¸è§„éœ‡è¡è¿è¡Œï¼šæ³¢å¹…" + str.tostring(priceStrength, "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + "å€ï¼Œç»´æŒåŒºé—´æ“ä½œ"

    // é‡ä»·å…³ç³»åˆ†æ
    volumePriceAnalysis = ""
    if isHighVolume and isObviousRise
        volumePriceAnalysis := "é‡ä»·é½å‡ï¼šæ”¾é‡ä¸Šæ¶¨(" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œå¤šå¤´å¼ºåŠ¿"
    else if isHighVolume and isObviousFall
        volumePriceAnalysis := "é‡å¢ä»·è·Œï¼šæ”¾é‡ä¸‹è·Œ(" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œç©ºå¤´åŠ›é‡å¼º"
    else if isLowVolume and isObviousRise
        volumePriceAnalysis := "é‡ä»·èƒŒç¦»ï¼šç¼©é‡ä¸Šæ¶¨(" + str.tostring(candleChangePercent, "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œåå¼¹ä¹åŠ›"
    else if isLowVolume and isObviousFall
        volumePriceAnalysis := "ç¼©é‡ä¸‹è·Œï¼šæ€è·Œæœ‰é™(" + str.tostring(math.abs(candleChangePercent), "#.##") + "%ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œææ…Œæƒ…ç»ªç¼“è§£"
    else if high > ta.highest(high, 10) and volume < ta.sma(volume, 5) * 0.8
        volumePriceAnalysis := "é‡ä»·èƒŒç¦»ï¼šåˆ›æ–°é«˜ä½†ç¼©é‡(" + formatPrice(high) + "ï¼Œé‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œè­¦æƒ•é¡¶éƒ¨é£é™©"
    else
        volumePriceAnalysis := "é‡ä»·é…åˆï¼šä»·é‡å…³ç³»æ­£å¸¸(é‡æ¯”" + str.tostring(volumeRatio, "#.##") + ")ï¼Œèµ°åŠ¿å¥åº·"

    // æ„å»ºäº”å¤§ç±»åˆ†ææç¤ºä¿¡æ¯
    tooltipText = "ã€Kçº¿åˆ†æã€‘" + candlePattern + "\n"
    tooltipText += "æ¶¨è·Œå¹…ï¼š" + str.tostring(candleChangePercent, "+#.##;-#.##") + "%"
    tooltipText += "ï¼Œæ³¢åŠ¨ï¼š" + str.tostring(((high-low)/close)*100, "#.##") + "%"
    tooltipText += "ï¼Œå®ä½“ï¼š" + str.tostring((candleBodySize/close)*100, "#.##") + "%\n\n"

    tooltipText += "ã€æˆäº¤é‡åˆ†æã€‘" + volumeDesc + "\n"
    tooltipText += "å½“å‰é‡ï¼š" + formatVolume(volume) + "ï¼Œå¹³å‡é‡ï¼š" + formatVolume(avgVolume) + "\n"
    tooltipText += "é‡æ¯”ï¼š" + str.tostring(volumeRatio, "#.##") + "ï¼Œ" + (volumeRatio > 1.5 ? "æ˜æ˜¾æ”¾é‡" : volumeRatio < 0.8 ? "æ˜æ˜¾ç¼©é‡" : "æ­£å¸¸æˆäº¤") + "\n\n"

    tooltipText += "ã€é‡ä»·åˆ†æã€‘" + volumePriceAnalysis + "\n"
    if macd_divergence != ""
        tooltipText += "èƒŒç¦»ä¿¡å·ï¼š" + macd_divergence + "ï¼Œå…³æ³¨è¶‹åŠ¿å˜åŒ–\n"
    tooltipText += "\n"

    tooltipText += "ã€æŠ€æœ¯æŒ‡æ ‡åˆ†æã€‘\n"
    tooltipText += "MACDï¼š" + (macd_line > signal_line ? "å¤šå¤´(" : "ç©ºå¤´(") + str.tostring(macd_line, "#.####") + ")" + 
                  (macd_line > signal_line and macd_line[1] <= signal_line[1] ? " ğŸ”¥é‡‘å‰" : 
                   macd_line < signal_line and macd_line[1] >= signal_line[1] ? " â„ï¸æ­»å‰" : ""
                  ) + "\n"
    tooltipText += "RSI(" + str.tostring(rsi, "#.1") + ")ï¼š" + 
                  (rsi > 80 ? "ğŸ”´ä¸¥é‡è¶…ä¹°" : rsi > 70 ? "ğŸŸ¡è¶…ä¹°åŒº" : 
                   rsi < 20 ? "ğŸŸ¢ä¸¥é‡è¶…å–" : rsi < 30 ? "ğŸŸ¡è¶…å–åŒº" : 
                   rsi > 50 ? "ğŸ’ªå¼ºåŠ¿åŒº" : "ğŸ“‰å¼±åŠ¿åŒº") + "\n"
    tooltipText += "KDJ(K:" + str.tostring(k, "#.1") + " D:" + str.tostring(d, "#.1") + ")ï¼š" + 
                  (k > d and k[1] <= d[1] ? "ğŸ”¥é‡‘å‰" : k < d and k[1] >= d[1] ? "â„ï¸æ­»å‰" : 
                   k > 80 and d > 80 ? "ğŸ”´è¶…ä¹°é’åŒ–" : k < 20 and d < 20 ? "ğŸŸ¢è¶…å–é’åŒ–" : "ä¸­æ€§") + "\n"
    tooltipText += "å‡çº¿ï¼š" + maStructure + "\n"
    tooltipText += "æ”¯æ’‘ï¼š" + supportDesc + "\n"
    tooltipText += "é˜»åŠ›ï¼š" + resistanceDesc + "\n\n"

    tooltipText += "ã€ç»“è®ºã€‘" + conclusion

    // æ›´æ–°Kçº¿ä¿¡æ¯æ˜¾ç¤ºæ¡ä»¶ï¼ˆä¸ºå…¨å±€plotshapeå‡†å¤‡ï¼‰
    showKlineInfo := isObviousRise or isObviousFall or math.abs(candleChangePercent) > 1.0
    
    // å°†æ–°çš„äº”å¤§ç±»åˆ†æå†…å®¹èµ‹å€¼ç»™candleTooltipç”¨äºæ˜¾ç¤º
    candleTooltip := tooltipText


// ===================================================
// === ä¸“ä¸šäº¤æ˜“ç­–ç•¥å‚æ•° ===
// ===================================================

// === äº¤æ˜“ç­–ç•¥æ€»å¼€å…³ ===
enableStrategy = input.bool(true, title = 'å¯ç”¨äº¤æ˜“ç­–ç•¥')

// === äº¤æ˜“æ–¹å‘è®¾ç½® ===
tradeDirection = input.string('çœ‹å¤š', title = 'äº¤æ˜“æ–¹å‘', options = ['çœ‹å¤š', 'çœ‹ç©º', 'æ‰€æœ‰'])

// ç­–ç•¥å¿«çº¿é€‰æ‹©
strategyFast = input.string('EMA1', title = 'ç­–ç•¥å¿«çº¿', options = ['EMA1', 'SMA1', 'EMA2', 'SMA2', 'EMA3', 'SMA3'])
// ç­–ç•¥æ…¢çº¿é€‰æ‹©
strategySlow = input.string('EMA2', title = 'ç­–ç•¥æ…¢çº¿', options = ['EMA1', 'SMA1', 'EMA2', 'SMA2', 'EMA3', 'SMA3'])

// === äº¤æ˜“æ—¥æœŸæ§åˆ¶ ===
startDate = input.time(timestamp("2025-01-01 00:00"), title = 'äº¤æ˜“å¼€å§‹æ—¥æœŸ')
endDate = input.time(timestamp("2099-01-01 00:00"), title = 'äº¤æ˜“ç»“æŸæ—¥æœŸ')

// === äº¤æ˜“æ—¥æœŸæ£€æŸ¥ ===
isInTradingPeriod = time >= startDate and time <= endDate


// === äº¤æ˜“æ‰§è¡Œä»·æ ¼ ===
entryTiming = input.string('æ”¶ç›˜ä»·', title = 'å¼€ä»“æ‰§è¡Œä»·æ ¼', options = ['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'ç›˜ä¸­'])
exitTiming = input.string('æ”¶ç›˜ä»·', title = 'å¹³ä»“æ‰§è¡Œä»·æ ¼', options = ['å¼€ç›˜ä»·', 'æ”¶ç›˜ä»·', 'ç›˜ä¸­'])

// === ç¼“å†²åŒºè®¾ç½® ===
bufferValue = input.float(0.0, title = 'ç¼“å†²åŒºæ•°å€¼', minval = 0.0, maxval = 50.0, step = 0.1, tooltip = 'å¼€ä»“ååœ¨æ­¤åŒºé—´å†…ä¸æ‰§è¡Œå½¢æ€ä¿®å¤å’Œå¹³ä»“ä¿¡å·')
bufferUnit = input.string('%', title = 'ç¼“å†²åŒºå•ä½', options = ['%', 'ä»·æ ¼'])

// === æ ¹æ®é€‰æ‹©è·å–å¯¹åº”çš„å‡çº¿å€¼ï¼ˆç”¨äºç­–ç•¥äº¤æ˜“ï¼‰ ===
strategyFastMA = strategyFast == 'EMA1' ? ema1 : strategyFast == 'SMA1' ? sma1 : strategyFast == 'EMA2' ? ema2 : strategyFast == 'SMA2' ? sma2 : strategyFast == 'EMA3' ? ema3 : sma3
strategySlowMA = strategySlow == 'EMA1' ? ema1 : strategySlow == 'SMA1' ? sma1 : strategySlow == 'EMA2' ? ema2 : strategySlow == 'SMA2' ? sma2 : strategySlow == 'EMA3' ? ema3 : sma3

// === æ ¸å¿ƒä¿¡å·è¯†åˆ« ===
// é‡‘å‰æ­»å‰ä¿¡å·
goldenCross = strategyFastMA > strategySlowMA and strategyFastMA[1] <= strategySlowMA[1] // é‡‘å‰ï¼šå¿«çº¿ä¸Šç©¿æ…¢çº¿
deathCross = strategyFastMA < strategySlowMA and strategyFastMA[1] >= strategySlowMA[1] // æ­»å‰ï¼šå¿«çº¿ä¸‹ç©¿æ…¢çº¿

// ç­–ç•¥è¶‹åŠ¿åˆ¤æ–­
strategyTrendUp = strategyFastMA > strategySlowMA
strategyTrendDown = strategyFastMA < strategySlowMA

// æ›´æ–°å…¨å±€è¶‹åŠ¿åˆ¤æ–­ä¸ºåŸºäºç­–ç•¥å‡çº¿
trendUp := strategyTrendUp
trendDown := strategyTrendDown


// === äº¤æ˜“æ‰§è¡Œä»·æ ¼è®¡ç®— ===
entryPrice_exec = entryTiming == 'å¼€ç›˜ä»·' ? open : entryTiming == 'æ”¶ç›˜ä»·' ? close : close

// === ç¼“å†²åŒºè®¡ç®— ===
var float bufferEntryPrice = na

// è®°å½•çœŸå®å¼€ä»“ä»·æ ¼ï¼ˆä½¿ç”¨ç­–ç•¥çš„å¹³å‡å¼€ä»“ä»·æ ¼ï¼‰
if strategy.position_size[1] == 0 and strategy.position_size != 0
    bufferEntryPrice := strategy.position_avg_price

// é‡ç½®ç¼“å†²åŒºï¼ˆå¹³ä»“æ—¶ï¼‰
if strategy.position_size == 0
    bufferEntryPrice := na

// è®¡ç®—ç¼“å†²åŒºè®¾ç½®
var float bufferUpperBound = na
var float bufferLowerBound = na
var bool bufferEnabled = false

if bufferValue > 0 and not na(bufferEntryPrice)
    if bufferUnit == '%'
        // ç™¾åˆ†æ¯”æ¨¡å¼
        bufferPercent = bufferValue / 100
        bufferUpperBound := bufferEntryPrice * (1 + bufferPercent)
        bufferLowerBound := bufferEntryPrice * (1 - bufferPercent)
    else
        // ä»·æ ¼æ¨¡å¼
        bufferUpperBound := bufferEntryPrice + bufferValue
        bufferLowerBound := bufferEntryPrice - bufferValue
    bufferEnabled := true
else
    bufferUpperBound := na
    bufferLowerBound := na
    bufferEnabled := false

// åˆ¤æ–­æ˜¯å¦åœ¨ç¼“å†²åŒºå†…
inBufferZone = bufferEnabled and not na(bufferEntryPrice) and close >= bufferLowerBound and close <= bufferUpperBound


// === ä¸“ä¸šäº¤æ˜“é€»è¾‘ ===
// === åšå¤šä¿¡å· ===
// 1. åšå¤šå¼€ä»“ä¿¡å·ï¼ˆç¬¬ä¸€æ¬¡é‡‘å‰ï¼‰
longEntrySignal = goldenCross and strategy.position_size == 0 and isInTradingPeriod

// 2. åšå¤šåŠ ä»“ä¿¡å·ï¼ˆé˜³çº¿ + è¶‹åŠ¿å‘ä¸Šï¼‰
// é˜³çº¿åˆ¤æ–­ï¼šæ”¶ç›˜ä»·é«˜äºå¼€ç›˜ä»·
isBullish = close > open

var lastAddPositionBar = 0
// å½“å‰ä»·æ ¼ç›¸å¯¹äºå¿«çº¿çš„åç¦»é‡ï¼Œç”¨äºåˆ¤æ–­å›è¸©
pullbackThreshold = 0.01 // å¯è°ƒå›è¸©å¹…åº¦ï¼Œä¾‹å¦‚ 1%
// åˆ¤æ–­å›è¸©æœªç ´å¿«çº¿
isPullback = close <= strategyFastMA * (1 + pullbackThreshold) and close >= strategyFastMA
// åŠ ä»“æ¡ä»¶ï¼šé˜³çº¿ + è¶‹åŠ¿å‘ä¸Š + å·²æœ‰å¤šå¤´ä»“ä½ + æ˜ç¡®å›è¸©å¿«çº¿
longAddSignal = isBullish and strategyTrendUp and strategy.position_size > 0 and isPullback and isInTradingPeriod

// 3. åšå¤šå¹³ä»“ä¿¡å·ï¼ˆæ­»å‰æˆ–å½¢æ€ç ´å¿«çº¿ï¼‰
// å½¢æ€ç ´å¿«çº¿åˆ¤æ–­ï¼šä»·æ ¼è·Œç ´å¿«çº¿
breakFastLine = close < strategyFastMA
// åŸºç¡€å¹³ä»“ä¿¡å·ï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
longExitSignal = (deathCross or breakFastLine) and strategy.position_size > 0 and not inBufferZone

// 4. åšå¤šé‡æ–°å…¥åœºä¿¡å·ï¼ˆå½¢æ€ä¿®å¤ï¼‰
// å½“ä»·æ ¼é‡æ–°å›åˆ°å¿«çº¿ä¹‹ä¸Šæ—¶ï¼Œå¯ä»¥é‡æ–°å…¥åœºï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
longReEntrySignal = close > strategyFastMA and strategy.position_size == 0 and strategyTrendUp and isInTradingPeriod and not inBufferZone

// === åšç©ºä¿¡å· ===
// 1. åšç©ºå¼€ä»“ä¿¡å·ï¼ˆç¬¬ä¸€æ¬¡æ­»å‰ï¼‰
shortEntrySignal = deathCross and strategy.position_size == 0 and isInTradingPeriod

// 2. åšç©ºåŠ ä»“ä¿¡å·ï¼ˆé˜´çº¿ + è¶‹åŠ¿å‘ä¸‹ï¼‰
// é˜´çº¿åˆ¤æ–­ï¼šæ”¶ç›˜ä»·ä½äºå¼€ç›˜ä»·
isBearish = close < open
// åˆ¤æ–­åå¼¹æœªç ´å¿«çº¿
isRebound = close >= strategyFastMA * (1 - pullbackThreshold) and close <= strategyFastMA
// åŠ ä»“æ¡ä»¶ï¼šé˜´çº¿ + è¶‹åŠ¿å‘ä¸‹ + å·²æœ‰ç©ºå¤´ä»“ä½ + æ˜ç¡®åå¼¹è‡³å¿«çº¿
shortAddSignal = isBearish and strategyTrendDown and strategy.position_size < 0 and isRebound and isInTradingPeriod

// 3. åšç©ºå¹³ä»“ä¿¡å·ï¼ˆé‡‘å‰æˆ–å½¢æ€ç ´å¿«çº¿ï¼‰
// å½¢æ€ç ´å¿«çº¿åˆ¤æ–­ï¼ˆåšç©ºæ—¶ä¸ºä»·æ ¼æ¶¨ç ´å¿«çº¿ï¼‰
breakFastLineShort = close > strategyFastMA
// åŸºç¡€å¹³ä»“ä¿¡å·ï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
shortExitSignal = (goldenCross or breakFastLineShort) and strategy.position_size < 0 and not inBufferZone

// 4. åšç©ºé‡æ–°å…¥åœºä¿¡å·ï¼ˆå½¢æ€ä¿®å¤ï¼‰
// å½“ä»·æ ¼é‡æ–°è·Œç ´å¿«çº¿æ—¶ï¼Œå¯ä»¥é‡æ–°åšç©ºå…¥åœºï¼ˆç¼“å†²åŒºå†…ä¸æ‰§è¡Œï¼‰
shortReEntrySignal = close < strategyFastMA and strategy.position_size == 0 and strategyTrendDown and isInTradingPeriod and not inBufferZone

// === å…¼å®¹æ€§å˜é‡ï¼ˆä¿æŒåŸæœ‰å˜é‡åï¼‰ ===
firstEntrySignal = longEntrySignal
pullbackSignal = longAddSignal
exitSignal = longExitSignal
reEntrySignal = longReEntrySignal

// === äº¤æ˜“æ‰§è¡Œä»·æ ¼åˆ¤æ–­ ===
canEntry = entryTiming == 'ç›˜ä¸­' or (entryTiming == 'å¼€ç›˜ä»·' and barstate.isconfirmed) or (entryTiming == 'æ”¶ç›˜ä»·' and barstate.isconfirmed)
canExit = exitTiming == 'ç›˜ä¸­' or (exitTiming == 'å¼€ç›˜ä»·' and barstate.isconfirmed) or (exitTiming == 'æ”¶ç›˜ä»·' and barstate.isconfirmed)

// æ ¹æ®é€‰æ‹©ç¡®å®šå¹³ä»“æ‰§è¡Œä»·æ ¼
exitPrice_exec = exitTiming == 'å¼€ç›˜ä»·' ? open : exitTiming == 'æ”¶ç›˜ä»·' ? close : close

// === äº¤æ˜“æ‰§è¡Œ ===
if enableStrategy
    // === åšå¤šäº¤æ˜“æ‰§è¡Œ ===
    if tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'
        // åšå¤šå¼€ä»“
        if longEntrySignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é‡‘å‰å¼€ä»“', strategy.long, qty = strategy.equity / entryPrice_exec)

        // åšå¤šåŠ ä»“
        if longAddSignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é˜³çº¿åŠ ä»“', strategy.long, qty = strategy.equity * 0.2 / entryPrice_exec)

        // åšå¤šå¹³ä»“
        if longExitSignal and canExit
            exitComment = deathCross ? 'æ­»å‰å¹³ä»“' : 'ç ´çº¿å¹³ä»“'
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.close_all(comment = exitComment)

        // åšå¤šé‡æ–°å…¥åœº
        if longReEntrySignal and canEntry
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.entry('å½¢æ€ä¿®å¤å…¥åœº', strategy.long, qty = strategy.equity / entryPrice_exec)

    // === åšç©ºäº¤æ˜“æ‰§è¡Œ ===
    if tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'
        // åšç©ºå¼€ä»“
        if shortEntrySignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('æ­»å‰å¼€ç©º', strategy.short, qty = strategy.equity / entryPrice_exec)

        // åšç©ºåŠ ä»“
        if shortAddSignal and canEntry
            if barstate.isconfirmed or entryTiming == 'ç›˜ä¸­'
                strategy.entry('é˜´çº¿åŠ ç©º', strategy.short, qty = strategy.equity * 0.2 / entryPrice_exec)

        // åšç©ºå¹³ä»“
        if shortExitSignal and canExit
            exitComment = goldenCross ? 'é‡‘å‰å¹³ä»“' : 'ç ´çº¿å¹³ä»“'
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.close_all(comment = exitComment)

        // åšç©ºé‡æ–°å…¥åœº
        if shortReEntrySignal and canEntry
            if barstate.isconfirmed or exitTiming == 'ç›˜ä¸­'
                strategy.entry('å½¢æ€ä¿®å¤åšç©º', strategy.short, qty = strategy.equity / entryPrice_exec)

// === ä¿¡å·æ ‡è®° ===
// åšå¤šä¿¡å·æ ‡è®°
plotshape(enableStrategy and longEntrySignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šå¼€ä»“', location = location.belowbar, color = color.green, style = shape.triangleup, size = size.normal)
plotshape(enableStrategy and longAddSignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šåŠ ä»“', location = location.belowbar, color = color.blue, style = shape.circle, size = size.small)
plotshape(enableStrategy and longExitSignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šå¹³ä»“', location = location.abovebar, color = color.red, style = shape.triangledown, size = size.normal)
plotshape(enableStrategy and longReEntrySignal and (tradeDirection == 'çœ‹å¤š' or tradeDirection == 'æ‰€æœ‰'), title = 'åšå¤šé‡å…¥', location = location.belowbar, color = color.lime, style = shape.diamond, size = size.small)

// åšç©ºä¿¡å·æ ‡è®°
plotshape(enableStrategy and shortEntrySignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºå¼€ä»“', location = location.abovebar, color = color.orange, style = shape.triangledown, size = size.normal)
plotshape(enableStrategy and shortAddSignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºåŠ ä»“', location = location.abovebar, color = color.purple, style = shape.circle, size = size.small)
plotshape(enableStrategy and shortExitSignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºå¹³ä»“', location = location.belowbar, color = color.yellow, style = shape.triangleup, size = size.normal)
plotshape(enableStrategy and shortReEntrySignal and (tradeDirection == 'çœ‹ç©º' or tradeDirection == 'æ‰€æœ‰'), title = 'åšç©ºé‡å…¥', location = location.abovebar, color = color.fuchsia, style = shape.diamond, size = size.small)

// === ç¼“å†²åŒºå¯è§†åŒ– ===
// ç¼“å†²åŒºå®ä½“æ˜¾ç¤ºï¼Œåªåœ¨ä»·æ ¼æœªçªç ´æ—¶æ˜¾ç¤º
bufferShow = bufferEnabled and not na(bufferUpperBound) and not na(bufferLowerBound) and not na(bufferEntryPrice) and close <= bufferUpperBound and close >= bufferLowerBound

// ç»˜åˆ¶ç¼“å†²åŒºä¸Šè¾¹ç•Œçº¿
bufferUpperLine = bufferShow ? bufferUpperBound : na
plot(bufferUpperLine, color = color.new(color.orange, 50), linewidth = 2, title = 'ç¼“å†²åŒºä¸Šè¾¹ç•Œ', style = plot.style_line)

// ç»˜åˆ¶ç¼“å†²åŒºä¸‹è¾¹ç•Œçº¿
bufferLowerLine = bufferShow ? bufferLowerBound : na
plot(bufferLowerLine, color = color.new(color.orange, 50), linewidth = 2, title = 'ç¼“å†²åŒºä¸‹è¾¹ç•Œ', style = plot.style_line)

// ç»˜åˆ¶ç¼“å†²åŒºä¸­çº¿ï¼ˆå¼€ä»“åŸºå‡†ä»·ï¼‰
bufferCenterLine = bufferShow ? bufferEntryPrice : na
plot(bufferCenterLine, color = color.new(color.blue, 60), linewidth = 1, title = 'å¼€ä»“åŸºå‡†ä»·', style = plot.style_line, linestyle = plot.linestyle_dashed)

// ç¼“å†²åŒºé€æ˜å®ä½“èƒŒæ™¯
fill(plot(bufferUpperLine, display = display.none), plot(bufferLowerLine, display = display.none), color = color.new(color.orange, 85), title = 'ç¼“å†²åŒºå®ä½“')

// === ç­–ç•¥ä¿¡æ¯æ˜¾ç¤º ===
var table infoTable = showInfoTable ? table.new(position.top_right, 2, enableCandleMarking ? 17 : 12, bgcolor = color.white, border_width = 1) : na
if barstate.islast and showInfoTable and not na(infoTable)
    table.cell(infoTable, 0, 0, 'ç­–ç•¥çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 0, 'åŒå‘å‡çº¿äº¤å‰ç­–ç•¥', text_color = color.black, bgcolor = color.gray)

    table.cell(infoTable, 0, 1, 'äº¤æ˜“æ–¹å‘', text_color = color.black, bgcolor = color.gray)
    directionColor = tradeDirection == 'çœ‹å¤š' ? color.green : tradeDirection == 'çœ‹ç©º' ? color.red : color.blue
    table.cell(infoTable, 1, 1, tradeDirection, text_color = color.black, bgcolor = directionColor)

    table.cell(infoTable, 0, 2, 'è¶‹åŠ¿åˆ¤æ–­', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 2, strategyTrendUp ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ', text_color = color.black, bgcolor = strategyTrendUp ? color.green : color.red)

    table.cell(infoTable, 0, 3, 'äº¤å‰ä¿¡å·', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 3, goldenCross ? 'é‡‘å‰' : deathCross ? 'æ­»å‰' : 'ç­‰å¾…', text_color = color.black, bgcolor = goldenCross ? color.green : deathCross ? color.red : color.gray)

    table.cell(infoTable, 0, 4, 'ç­–ç•¥å¿«çº¿', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 4, strategyFast, text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 5, 'ç­–ç•¥æ…¢çº¿', text_color = color.black, bgcolor = color.gray)
    table.cell(infoTable, 1, 5, strategySlow, text_color = color.black, bgcolor = color.orange)

    table.cell(infoTable, 0, 6, 'å½“å‰ä»“ä½', text_color = color.black, bgcolor = color.gray)
    positionStatus = strategy.position_size > 0 ? 'å¤šå¤´' : strategy.position_size < 0 ? 'ç©ºå¤´' : 'ç©ºä»“'
    positionBgColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 1, 6, positionStatus, text_color = color.black, bgcolor = positionBgColor)

    table.cell(infoTable, 0, 7, 'ä»“ä½æ¯”ä¾‹', text_color = color.black, bgcolor = color.gray)
    positionRatio = math.abs(strategy.position_size * close / strategy.equity)
    table.cell(infoTable, 1, 7, str.tostring(positionRatio * 100, '#.##') + '%', text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 8, 'å½¢æ€çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    formationStatus = strategy.position_size > 0 ? (close > strategyFastMA ? 'å½¢æ€å®Œå¥½' : 'å½¢æ€ç ´å¿«') : strategy.position_size < 0 ? (close < strategyFastMA ? 'å½¢æ€å®Œå¥½' : 'å½¢æ€ç ´å¿«') : (close > strategyFastMA ? 'å¤šå¤´å½¢æ€' : 'ç©ºå¤´å½¢æ€')
    formationColor = strategy.position_size > 0 ? (close > strategyFastMA ? color.green : color.red) : strategy.position_size < 0 ? (close < strategyFastMA ? color.green : color.red) : (close > strategyFastMA ? color.lime : color.orange)
    table.cell(infoTable, 1, 8, formationStatus, text_color = color.black, bgcolor = formationColor)

    table.cell(infoTable, 0, 9, 'ç¼“å†²åŒºçŠ¶æ€', text_color = color.black, bgcolor = color.gray)
    bufferStatus = ''
    if bufferEnabled and not na(bufferEntryPrice)
        if inBufferZone
            bufferStatus := 'ä¿¡å·å±è”½ä¸­'
        else
            bufferStatus := 'æ­£å¸¸äº¤æ˜“'
    else if bufferValue > 0
        bufferStatus := 'ç­‰å¾…å¼€ä»“'
    else
        bufferStatus := 'å·²å…³é—­'

    bufferColor = bufferEnabled and not na(bufferEntryPrice) ? (inBufferZone ? color.red : color.green) : color.gray
    table.cell(infoTable, 1, 9, bufferStatus, text_color = color.black, bgcolor = bufferColor)

    table.cell(infoTable, 0, 10, 'ç¼“å†²åŒºè®¾ç½®', text_color = color.black, bgcolor = color.gray)
    bufferSettingText = ''
    if bufferEnabled and not na(bufferEntryPrice)
        if bufferUnit == '%'
            bufferSettingText := str.tostring(bufferValue, '#.#') + '% [' + str.tostring(bufferLowerBound, '#.##') + ' - ' + str.tostring(bufferUpperBound, '#.##') + ']'
        else
            bufferSettingText := str.tostring(bufferValue, '#.##') + ' [' + str.tostring(bufferLowerBound, '#.##') + ' - ' + str.tostring(bufferUpperBound, '#.##') + ']'
    else
        bufferSettingText := bufferValue > 0 ? 'ç­‰å¾…å¼€ä»“' : 'å…³é—­'
    table.cell(infoTable, 1, 10, bufferSettingText, text_color = color.black, bgcolor = color.blue)

    table.cell(infoTable, 0, 11, 'Kçº¿åˆ†æ', text_color = color.black, bgcolor = color.gray)
    candleMarkText = ''
    if enableCandleMarking
        if isObviousRise
            candleMarkText := 'ğŸ“ˆ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
        else if isObviousFall
            candleMarkText := 'ğŸ“‰ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
        else
            candleMarkText := 'â¡ï¸ ' + str.tostring(candleChangePercent, '#.##') + '% [è¯¦æƒ…]'
    else
        candleMarkText := 'å·²å…³é—­'

    candleMarkColor = enableCandleMarking ? (isObviousRise ? color.lime : isObviousFall ? color.red : color.gray) : color.gray
    table.cell(infoTable, 1, 11, candleMarkText, text_color = color.black, bgcolor = candleMarkColor)

    // Kçº¿è¯¦ç»†åˆ†æä¿¡æ¯ï¼ˆå½“å¯ç”¨Kçº¿æ ‡è®°æ—¶æ˜¾ç¤ºæ›´å¤šè¡Œï¼‰
    if enableCandleMarking
        // è¯¦ç»†Kçº¿æ•°æ®
        table.cell(infoTable, 0, 12, 'OHLCæ•°æ®', text_color = color.black, bgcolor = color.gray)
        ohlcText = 'O:' + str.tostring(open, '#.##') + ' H:' + str.tostring(high, '#.##') + ' L:' + str.tostring(low, '#.##') + ' C:' + str.tostring(close, '#.##')
        table.cell(infoTable, 1, 12, ohlcText, text_color = color.black, bgcolor = color.blue)

        // é‡ä»·å…³ç³»åˆ†æ
        table.cell(infoTable, 0, 13, 'é‡ä»·å…³ç³»', text_color = color.black, bgcolor = color.gray)
        volumePriceText = ''
        volumePriceColor = color.gray
        if isObviousRise and isHighVolume
            volumePriceText := 'ğŸŸ¢ æ¶¨é‡é…åˆ-å¥åº·ä¸Šæ¶¨'
            volumePriceColor := color.lime
        else if isObviousRise and isLowVolume
            volumePriceText := 'ğŸŸ¡ æ¶¨ç¼©é‡-éœ€è¦è­¦æƒ•'
            volumePriceColor := color.yellow
        else if isObviousFall and isHighVolume
            volumePriceText := 'ğŸ”´ è·Œé‡é‡Šæ”¾-ç©ºå¤´å‘åŠ›'
            volumePriceColor := color.red
        else if isObviousFall and isLowVolume
            volumePriceText := 'ğŸŸ  è·Œç¼©é‡-æ€è·Œæœ‰é™'
            volumePriceColor := color.orange
        else
            volumePriceText := 'âšª æ­£å¸¸éœ‡è¡'
        table.cell(infoTable, 1, 13, volumePriceText, text_color = color.black, bgcolor = volumePriceColor)

        // æˆäº¤é‡è¯¦ç»†åˆ†æ
        table.cell(infoTable, 0, 14, 'æˆäº¤é‡è¯¦æƒ…', text_color = color.black, bgcolor = color.gray)
        volumeDetailText = str.tostring(volume/avgVolume, '#.##') + 'å€ ('
        if isHighVolume
            volumeDetailText += 'æ”¾é‡>'  + str.tostring(volumeHighThreshold, '#.#') + 'å€)'
        else if isLowVolume
            volumeDetailText += 'ç¼©é‡<' + str.tostring(volumeLowThreshold, '#.#') + 'å€)'
        else
            volumeDetailText += 'æ­£å¸¸é‡)'
        volumeColor = isHighVolume ? color.lime : isLowVolume ? color.orange : color.gray
        table.cell(infoTable, 1, 14, volumeDetailText, text_color = color.black, bgcolor = volumeColor)

        // å‡çº¿å…³ç³»åˆ†æ
        table.cell(infoTable, 0, 15, 'å‡çº¿å…³ç³»', text_color = color.black, bgcolor = color.gray)
        maRelationText = 'å¿«çº¿(' + strategyFast + ')è·ç¦»:' + str.tostring(((close - strategyFastMA) / strategyFastMA) * 100, '#.##') + '% | æ…¢çº¿(' + strategySlow + ')è·ç¦»:' + str.tostring(((close - strategySlowMA) / strategySlowMA) * 100, '#.##') + '%'
        maRelationColor = close > strategyFastMA and close > strategySlowMA ? color.lime : close < strategyFastMA and close < strategySlowMA ? color.red : color.yellow
        table.cell(infoTable, 1, 15, maRelationText, text_color = color.black, bgcolor = maRelationColor)

        // è¶‹åŠ¿çŠ¶æ€
        table.cell(infoTable, 0, 16, 'è¶‹åŠ¿çŠ¶æ€', text_color = color.black, bgcolor = color.gray)
        trendText = trendUp ? 'ğŸ“ˆ å¤šå¤´è¶‹åŠ¿ (' + strategyFast + '>' + strategySlow + ')' : 'ğŸ“‰ ç©ºå¤´è¶‹åŠ¿ (' + strategyFast + '<' + strategySlow + ')'
        trendColor = trendUp ? color.green : color.red
        table.cell(infoTable, 1, 16, trendText, text_color = color.black, bgcolor = trendColor)


